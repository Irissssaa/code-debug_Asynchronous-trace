#### 测试总结

- 以下测试总结：

	总的来说，我们工具的能力边界可以用一句话来概括：

	> **它能够成功追踪所有由编译器生成的、使用具体类型 (Concrete Types) 的异步代码，因为这类代码会产生可预测的、结构化的 DWARF 信息。但当代码中出现手动实现、类型擦除 (`dyn Trait`) 或某些极端编译器优化时，这种可预测的结构被打破，工具便会失效。**

	下面是详细的分类：

	✅ **可以成功追踪的 `poll` 函数**

	覆盖了绝大多数日常的 `async`/`await` 用法。

	1. **标准 `async fn`**
		- **例子**: `async fn standard_async_fn() -> i32 { ... }`
		- **原因**: 这是最基本的情况。编译器会生成具有 `{async_fn#0}` (poll 函数) 和 `{async_fn_env#0}` (Future 状态机) 这种清晰、可预测的“兄弟节点” DWARF 结构。我们的脚本正是为此设计的。
	2. **`async` 块**
		- **例子**: `async { ... }`
		- **原因**: 与 `async fn` 类似，编译器会生成 `{async_block#0}` 和 `{async_block_env#0}` 的兄弟节点，同样能被我们的脚本正确识别和关联。
	3. **嵌套的异步函数调用**
		- **例子**: `nested_async_fn` 中 `await` 了 `standard_async_fn` 和 `async_block`。
		- **原因**: 依赖扩展功能 (`start-async-debug` 的第 3 步) 是这个工具的核心优势。只要起点是一个可追踪的 Future，它就能利用 `async_dependencies.json` 这份“地图”，自动找到并插桩整个调用链上的所有可追踪的 `poll` 函数。
	4. **带泛型和生命周期的 `async fn`**
		- **例子**: `generic_async_fn<T>(...)`, `lifetime_async_fn<'a>(...)`
		- **原因**: 只要不涉及类型擦除，泛型和生命周期通常只是在类型名称上有所体现 (`...<i32>`)，并不会改变 `poll`/`Future` 兄弟节点的底层 DWARF 结构。我们的脚本能够正确处理这些名称。
	5. **`impl` 块中的 `async fn`**
		- **例子**: `impl MyStruct { async fn impl_async_fn(&self) { ... } }`
		- **原因**: 这种 `async fn` 同样遵循标准的编译器生成模式，会产生可预测的 `{impl#...}` 命名空间，并在其下生成可被关联的 `poll` 函数和 `Future` 结构体。

	------

	❌ **无法 成功追踪的 `poll` 函数**

	这些情况暴露了工具的设计边界。

	1. **手动实现的 `Future` (`impl Future for ...`)**

		- **例子**: `impl Future for ManualFuture { fn poll(...) }`
		- **根本原因**: **DWARF 结构和命名约定完全不同**。
			- `poll` 函数是 `Future` 结构体的“孙子”节点，而非“兄弟”。
			- `poll` 函数就叫 `poll`，`Future` 结构体是自定义名 `ManualFuture`，两者名字之间没有程序化的关联。我们为解决此问题而设计的“`self` 参数分析”法也因 DWARF 结构过于复杂而失败。

	2. **返回 `Box<dyn Future>` 的函数**

		- **例子**: `fn boxed_future() -> Pin<Box<dyn Future<...>>> { ... }`
		- **根本原因**: **类型擦除 (Type Erasure)**。
			- `dyn Future` 这个 Trait 对象向外界隐藏了内部 `async` 块的具体类型。
			- 这导致编译器生成的 DWARF 信息中，`poll` 函数和 `Future` 状态机之间的“兄弟”关联被打破或变得不可预测，我们的脚本无法再将它们稳定地链接起来。

	3. **使用了 `#[async_trait]` 的函数**

		- **例子**: `#[async_trait] async fn my_method() { ... }`
		- **根本原因**: **与 `Box<dyn Future>` 完全相同**。`#[async_trait]` 宏的本质就是将 `async fn` 自动重写成一个返回 `Pin<Box<dyn Future<...>>>` 的普通函数，因此它继承了类型擦除带来的所有问题。

	4. **被完全内联优化的 `async fn`**

		- **例子**: 最初版本的 `combinators_async_fn`。
		- **根本原因**: **编译器优化**。
			- 如果一个 `async` 函数的逻辑过于简单，从不真正挂起（即从不返回 `Poll::Pending`），编译器可能会将其整个函数体“内联”到调用处。
			- 这导致对应的 `poll` 函数虽然存在于符号表中，但没有任何 `call` 指令会去调用它，因此设置在它上面的断点永远不会被触发。

	5. 补充总结：

		<img src="https://p.ipic.vip/yn0kia.png" alt="截屏2025-08-09 16.05.51" style="zoom:50%;" />

- 理解代码：
	- `init-dwarf-analysis` 这个脚本的主要目的是：
		1. 从可执行文件中读取DWARF调试信息
		2. 创建一个树状模型来表示这些信息
		3. 在GDB环境中提供访问这些信息的接口
	- 写了一个完整的测试用例，来测试各种常见poll函数生成的情况，`tests/comprehensive_async_test/target/debug/comprehensive_async_test` ，改了Makefile文件中的一些路径；获得了相应的依赖关系文件，以及该程序的poll_map.json，收集到了45个poll函数，其中大部分是 [tokio](javascript:void(0)) 和 `futures-util` 库生成的poll函数，对于调试用户代码来说通常不是关注的重点，所以不用管。

- ![截屏2025-08-08 15.13.30](https://p.ipic.vip/3xtwsf.png)

#### 初步测试

标准 async 函数 {async_fn# } 能正常跟踪，测试其他几种情况：

- 异步块 {async_block# }

	```json
		"src/main.rs:15": {
	      "fn_name": "static fn comprehensive_async_test::async_block::{async_block#0}(*mut core::task::wake::Context)",
	      "return_type": "core::task::poll::Poll<i32>",
	      "async_backtrace": true
	    },
	```

	![截屏2025-08-08 15.21.24](https://p.ipic.vip/w8q7dp.png)

	可以看到异步块返回的poll函数无法跟踪。

- 手动实现 Future trait

	```json
	   "src/main.rs:29": {
	     "fn_name": "static fn comprehensive_async_test::{impl#0}::poll(core::pin::Pin<&mut comprehensive_async_test::ManualFutu>
	     "return_type": "core::task::poll::Poll<i32>",
	     "async_backtrace": true
	   },
	```

	![截屏2025-08-08 15.39.22](https://p.ipic.vip/t9mdkg.png)

- 通过 Box 包装的 Future

	```json
	   "src/main.rs:45": {
	     "fn_name": "static fn comprehensive_async_test::boxed_future::{async_block#0}(*mut core::task::wake::Context)",
	     "return_type": "core::task::poll::Poll<i32>",
	     "async_backtrace": false
	   },
	```

- 使用 async-trait 的 trait

	```json
	   "src/main.rs:61": {
	     "fn_name": "static fn comprehensive_async_test::{impl#2}::async_method::{async_block#0}(*mut core::task::wake::Context)>
	     "return_type": "core::task::poll::Poll<i32>",
	     "async_backtrace": false
	   },
	```

- 泛型 async fn

	```json
	   "src/main.rs:68": {
	     "fn_name": "static fn comprehensive_async_test::generic_async_fn::{async_fn#0}<i32>(*mut core::task::wake::Context)",
	     "return_type": "core::task::poll::Poll<i32>",
	     "async_backtrace": false
	   },
	```

- 带生命周期的 async fn

- 在 impl 块中的 async fn

- 使用 futures crate 的 combinators

	```json
	   "src/main.rs:93": {
	     "fn_name": "static fn comprehensive_async_test::combinators_async_fn::{async_fn#0}::{async_block#1}(core::pin::Pin<&mut>
	     "return_type": "core::task::poll::Poll<i32>",
	     "async_backtrace": false
	   },
	```

#### 改bug + 补充跟踪类型 + 最终测试结果 



##### 嵌套的异步函数调用

```shell
(gdb) start-async-debug 
[rust-future-tracing] Step 1: Reading user-selected interesting functions...
[rust-future-tracing] Found interesting poll function: static fn comprehensive_async_test::nested_async_fn::{async_fn#0}(*mut core::task::wake::Context)
[rust-future-tracing] Mapped static fn comprehensive_async_test::nested_async_fn::{async_fn#0}(*mut core::task::wake::Context) -> comprehensive_async_test::nested_async_fn::{async_fn_env#0} (DIE offset: 409548)
[rust-future-tracing] Found 1 interesting futures:
  - comprehensive_async_test::nested_async_fn::{async_fn_env#0}
[rust-future-tracing] === Step 3: Performing future expansion ===
[rust-future-tracing] Converting interesting futures to DIE offsets...
[rust-future-tracing] Converting future to DIE offset: comprehensive_async_test::nested_async_fn::{async_fn_env#0}
[rust-future-tracing] No poll function found for future struct: {async_fn_env#0}
[rust-future-tracing] No poll function found for future struct: {async_fn_env#0}
[rust-future-tracing] No poll function found for future struct: {async_fn_env#0}
[rust-future-tracing] No poll function found for future struct: {async_fn_env#0}
[rust-future-tracing] No poll function found for future struct: {async_fn_env#0}
[rust-future-tracing] No poll function found for future struct: {async_fn_env#0}
[rust-future-tracing] No poll function found for future struct: {async_fn_env#0}
[rust-future-tracing] No poll function found for future struct: {async_fn_env#0}
[rust-future-tracing] No poll function found for future struct: {async_fn_env#0}
[rust-future-tracing] No poll function found for future struct: {async_fn_env#0}
[rust-future-tracing] No poll function found for future struct: {async_fn_env#0}
[rust-future-tracing] No poll function found for future struct: {async_fn_env#0}
[rust-future-tracing] No poll function found for future struct: {async_fn_env#0}
[rust-future-tracing] No poll function found for future struct: {async_fn_env#0}
[rust-future-tracing] No poll function found for future struct: {async_fn_env#0}
[rust-future-tracing] Mapped comprehensive_async_test::nested_async_fn::{async_fn_env#0} -> DIE offset: 409548
[rust-future-tracing] Expanding future dependencies...
[rust-future-tracing] Loaded async dependencies from /home/iristseng/data/rust-future-tracing/results/async_dependencies.json
[rust-future-tracing] Expanding dependencies for DIE offset: 0x63fcc
--Type <RET> for more, q to quit, c to continue without paging--c
[rust-future-tracing] Expansion complete:
  - Total expanded DIE offsets: 1
  - Leaf futures (no dependencies): 1
  - Root futures (coroutines): 1
[rust-future-tracing] Validating expanded futures with DIE tree...
[rust-future-tracing] Validation complete:
  - Async functions: 0
  - Future structs: 1
  - Other DIEs: 0
  - Invalid offsets: 0
[rust-future-tracing] === Step 3 complete ===
[rust-future-tracing] Step 3 complete. Expanded to 1 total futures
[rust-future-tracing] === Step 4: Converting expanded futures to poll functions ===
[rust-future-tracing] Converting future to poll function: {async_fn_env#0} (offset: 409548)
[rust-future-tracing] Mapped future -> poll: {async_fn_env#0} -> comprehensive_async_test::nested_async_fn::{async_fn#0} (DIE offset: 409306)
[rust-future-tracing] Step 4 complete. Found 1 unique poll functions:
  1. comprehensive_async_test::nested_async_fn::{async_fn#0}
[rust-future-tracing] Step 4 complete. Ready to instrument 1 poll functions
[rust-future-tracing] Initialized AsyncBacktracePlugin for 1 poll functions.
[rust-future-tracing] === Step 5: Setting up instrumentation for poll functions ===
[rust-future-tracing] Processing future struct: {async_fn_env#0} at offset 409548
[rust-future-tracing] Ancestors: {}
  - Will instrument: comprehensive_async_test::nested_async_fn::{async_fn#0}
[rust-future-tracing] === Step 5 complete ===
[rust-future-tracing] Setting up entry breakpoint for: comprehensive_async_test::nested_async_fn::{async_fn#0}
[rust-future-tracing] All steps complete. Instrumentation is active.
Hint: Use 'continue' or 'run' to start the program, then 'inspect-async' to see results.
(gdb) run
Starting program: /home/iristseng/data/rust-future-tracing/tests/comprehensive_async_test/target/debug/comprehensive_async_test 

This GDB supports auto-downloading debuginfo from the following URLs:
  <https://debuginfod.ubuntu.com>
Enable debuginfod for this session? (y or [n]) y
Debuginfod has been enabled.
To make this setting permanent, add 'set debuginfod enabled on' to .gdbinit.
Downloading separate debug info for system-supplied DSO at 0x7ffff7fc3000
[Thread debugging using libthread_db enabled]                                                                                   
Using host libthread_db library "/lib/x86_64-linux-gnu/libthread_db.so.1".
[New Thread 0x7ffff7a006c0 (LWP 9268)]
[New Thread 0x7ffff76006c0 (LWP 9269)]
开始测试各种异步实现方式
standard_async_fn result: 42
async_block result: 100
boxed_future result: 200
async_trait result: 300
generic_async_fn result: 600
lifetime_async_fn result: hello
impl_async_fn result: 500
combinators_async_fn result: 1

Thread 1 "comprehensive_a" hit Temporary breakpoint -12, comprehensive_async_test::nested_async_fn::{async_fn#0} ()
    at src/main.rs:102
102	async fn nested_async_fn() -> i32 {
================================================================================
                            Asynchronous Backtraces
================================================================================
Process 9264:
  Thread 9264:
    Coroutine '{async_fn_env#0}' (ID: 409548):
         comprehensive_async_test::nested_async_fn::{async_fn_env#0}
================================================================================
================================================================================
                            Asynchronous Backtraces
================================================================================
Process 9264:
  Thread 9264:
    Coroutine '{async_fn_env#0}' (ID: 409548):
      Stack is empty.
================================================================================

Thread 1 "comprehensive_a" hit Temporary breakpoint -13, comprehensive_async_test::nested_async_fn::{async_fn#0} ()
    at src/main.rs:102
102	async fn nested_async_fn() -> i32 {
================================================================================
                            Asynchronous Backtraces
================================================================================
Process 9264:
  Thread 9264:
    Coroutine '{async_fn_env#0}' (ID: 409548):
         comprehensive_async_test::nested_async_fn::{async_fn_env#0}
================================================================================
================================================================================
                            Asynchronous Backtraces
================================================================================
Process 9264:
  Thread 9264:
    Coroutine '{async_fn_env#0}' (ID: 409548):
      Stack is empty.
================================================================================
nested_async_fn result: 142
所有测试完成
[Thread 0x7ffff76006c0 (LWP 9269) exited]
[Thread 0x7ffff7a006c0 (LWP 9268) exited]
[Inferior 1 (process 9264) exited normally]
```

跟踪结果很显然不是我们想要的。而且还有一个问题是，工具没有找到这个poll函数相关的future，然后我去compreh_async_test_dependencies.json中找这个poll函数对应的future（63fcc），但是没有找到，找到的是`"60c4a":"Pin<&mut comprehensive_async_test::nested_async_fn::{async_fn_env#0}>"`，而不是`comprehensive_async_test::nested_async_fn::{async_fn_env#0}`，然后我去看**60c4a**的依赖关系，是空的，但是按理来说不会是空的。

于是，就这个函数，我在该程序的dwarf信息中一顿搜索，都始终没有找到我用 `grep` 命令没有命中 `nested_async_fn` future 自身的 `$DW_TAG_structure_type` 定义块，找到的全是目标类型的**引用和使用**：

```shell
<238ee>   DW_AT_name      : (indirect string, offset: 0x2a4205): drop_in_place<comprehensive_async_test::nested_async_fn::{async_fn_env#0}>

<5fc98>   DW_AT_name      : (indirect string, offset: 0x32a0a8): into_future<comprehensive_async_test::nested_async_fn::{async_fn_env#0}>

<6003b>   DW_AT_name      : (indirect string, offset: 0x16c5ee): Pin<&mut comprehensive_async_test::nested_async_fn::{async_fn_env#0}>

<64c28>   DW_AT_name      : (indirect string, offset: 0x355f8b): &mut comprehensive_async_test::nested_async_fn::{async_fn_env#0}
```

新的结论是：`nested_async_fn::{async_fn_env#0}` 这个状态机结构体本身，在 DWARF 中很可能是一个没有名字的匿名类型。这在编译器生成的类型中非常常见。结构体本身`$DW_AT_name$` 属性中没有函数名关键字，匿名的，但所有指向它、使用它的地方（比如指针、`Pin` 等）为了方便调试，会给自己的类型安上一个描述性的名字，比如 `&mut comprehensive_async_test::nested_async_fn::{async_fn_env#0}`。于是我们现在要做的不是找名字，而是要反向追踪。在dwarf输出中，有这么一段决定性的信息：

```shell
<1><64c23>: Abbrev Number: 27 (DW_TAG_pointer_type)
    <64c24>   DW_AT_type          : <0x63fcc>
    <64c28>   DW_AT_name          : (indirect string, offset: 0x355f8b): &mut comprehensive_async_test::nested_async_fn::{async_fn_env#0}
```

这里：

- **`<64c23>`**: DWARF 在这里定义了一个指针类型（`DW_TAG_pointer_type`）。
- **`<64c28>`**: 这个指针类型的**名字**是 `&mut comprehensive_async_test::nested_async_fn::{async_fn_env#0}`。
- **`<64c24>`**: **最关键的一行！** `$DW_AT_type: <0x63fcc>` 告诉我们，这个指针指向的**基础类型**是在 DWARF 偏移量 `<0x63fcc>` 处定义的。

**我们找到了它的地址，我们要找的那个匿名状态机结构体，它的定义就位于 `<0x63fcc>`。**通过下面命令：

```shell
readelf -wi tests/comprehensive_async_test/target/debug/comprehensive_async_test | grep -A50 "<63fcc>"
```

我们获得了一下内容：

```shell
<3><63fcc>: Abbrev Number: 32 (DW_TAG_structure_type)
    <63fcd>   DW_AT_name        : (indirect string, offset: 0x2d120): {async_fn_env#0}
    <63fd1>   DW_AT_byte_size   : 128
    <63fd2>   DW_AT_alignment   : 8
```

经过一番探索，我确定了原async_deps.py文件有问题，会遗漏很多future，查找出具体原因如下：

这个问题的根源在于脚本处理**重名结构体**的方式。

在 DWARF 中，像 `{async_fn_env#0}` 这样的名字是编译器生成的**非唯一**名称。多个不同的 `async` 函数（比如 `standard_async_fn` 和 `nested_async_fn`）都可能生成同名的状态机结构体。

仔细审查脚本中的 `_parse_struct_block` 函数是如何处理这个问题的：

```python
# _parse_struct_block 函数内部

# ... 其他解析 ...

if name:
    unique_name = name
    # 问题就在这一行！
    if name in self.structs and type_id:
        unique_name = f"{name}<0x{type_id}>"
    
    struct = Struct(...)
    
    # 脚本使用（可能）不唯一的 name/unique_name 作为主键
    self.structs[unique_name] = struct 
    
    if type_id:
        # 这个字典是从唯一的 type_id 映射到不一定唯一的名字
        self.type_id_to_struct[type_id] = unique_name
```

这里的逻辑试图通过给重名的结构体附加 `type_id` 来创建唯一的名字（`unique_name`）。然而，这个逻辑存在一个漏洞：

1. **第一次遇到 `{async_fn_env#0}`**: 假设脚本先解析到了 `standard_async_fn` 的状态机。它的名字是 `{async_fn_env#0}`。此时 `name in self.structs` 为 `False`。于是脚本使用原始名字作为键，执行了 `self.structs['{async_fn_env#0}'] = ...`。
2. **第二次遇到 `{async_fn_env#0}`**: 接着，脚本解析到了 `nested_async_fn` 的状态机（位于 `<63fcc>`）。它的名字也是 `{async_fn_env#0}`。此时 `name in self.structs` 为 `True`。脚本会为它创建一个唯一的名字，如 `{async_fn_env#0}<0x63fcc>`，然后存入 `self.structs`。

到这里看起来似乎没问题。但**如果由于某种原因（例如，某个没有 `type_id` 的重名结构体被先解析），导致 `if name in self.structs and type_id:` 这个条件判断没按预期走，就可能发生**键冲突和覆盖**。一个更简单、更常见的失败模式是，`_resolve_deps_recursive` 函数在解析依赖时，依赖的是 `type_id_to_struct` 和 `structs` 两个字典的协同工作，这个过程中的任何不一致都可能导致依赖链断裂。

**最核心的缺陷在于：脚本设计上依赖字符串名字作为主键，而这个名字本身是不可靠的、非唯一的。**

如何修复这个脚本，改变其核心存储逻辑：**始终使用唯一的 `type_id` (DIE Offset) 作为所有字典的主键，彻底抛弃使用 `name` 作为主键的做法。**

修改后能够获取完整的依赖关系了。

解决完依赖关系的问题，后面是进一步看能否找到完整的依赖关系，并成功转换后进行插桩。

接下来进行调试跟踪获得的结果：

```shell
(gdb) start-async-debug 
[rust-future-tracing] Step 1: Reading user-selected interesting functions...
[rust-future-tracing] Found interesting poll function: static fn comprehensive_async_test::nested_async_fn::{async_fn#0}(*mut core::task::wake::Context)
[rust-future-tracing] Mapped static fn comprehensive_async_test::nested_async_fn::{async_fn#0}(*mut core::task::wake::Context) -> comprehensive_async_test::nested_async_fn::{async_fn_env#0} (DIE offset: 409548)
[rust-future-tracing] Found 1 interesting futures:
  - comprehensive_async_test::nested_async_fn::{async_fn_env#0}
[rust-future-tracing] === Step 3: Performing future expansion ===
[rust-future-tracing] Converting interesting futures to DIE offsets...
[rust-future-tracing] Converting future to DIE offset: comprehensive_async_test::nested_async_fn::{async_fn_env#0}
[rust-future-tracing] No poll function found for future struct: {async_fn_env#0}
[rust-future-tracing] No poll function found for future struct: {async_fn_env#0}
[rust-future-tracing] No poll function found for future struct: {async_fn_env#0}
[rust-future-tracing] No poll function found for future struct: {async_fn_env#0}
[rust-future-tracing] No poll function found for future struct: {async_fn_env#0}
[rust-future-tracing] No poll function found for future struct: {async_fn_env#0}
[rust-future-tracing] No poll function found for future struct: {async_fn_env#0}
[rust-future-tracing] No poll function found for future struct: {async_fn_env#0}
[rust-future-tracing] No poll function found for future struct: {async_fn_env#0}
[rust-future-tracing] No poll function found for future struct: {async_fn_env#0}
[rust-future-tracing] No poll function found for future struct: {async_fn_env#0}
[rust-future-tracing] No poll function found for future struct: {async_fn_env#0}
[rust-future-tracing] No poll function found for future struct: {async_fn_env#0}
[rust-future-tracing] No poll function found for future struct: {async_fn_env#0}
[rust-future-tracing] No poll function found for future struct: {async_fn_env#0}
[rust-future-tracing] Mapped comprehensive_async_test::nested_async_fn::{async_fn_env#0} -> DIE offset: 409548
[rust-future-tracing] Expanding future dependencies...
[rust-future-tracing] Loaded async dependencies from /home/iristseng/data/rust-future-tracing/results/async_dependencies.json
[rust-future-tracing] Expanding dependencies for DIE offset: 0x63fcc
[rust-future-tracing] Expansion complete:
--Type <RET> for more, q to quit, c to continue without paging--c
  - Total expanded DIE offsets: 4
  - Leaf futures (no dependencies): 3
  - Root futures (coroutines): 3
[rust-future-tracing] Validating expanded futures with DIE tree...
[rust-future-tracing] Validation complete:
  - Async functions: 0
  - Future structs: 2
  - Other DIEs: 2
  - Invalid offsets: 0
[rust-future-tracing] === Step 3 complete ===
[rust-future-tracing] Step 3 complete. Expanded to 4 total futures
[rust-future-tracing] === Step 4: Converting expanded futures to poll functions ===
[rust-future-tracing] Converting future to poll function: {async_fn_env#0} (offset: 409548)
[rust-future-tracing] Mapped future -> poll: {async_fn_env#0} -> comprehensive_async_test::nested_async_fn::{async_fn#0} (DIE offset: 409306)
[rust-future-tracing] Converting future to poll function: {async_fn_env#0} (offset: 406906)
[rust-future-tracing] Mapped future -> poll: {async_fn_env#0} -> comprehensive_async_test::standard_async_fn::{async_fn#0} (DIE offset: 406797)
[rust-future-tracing] Step 4 complete. Found 2 unique poll functions:
  1. comprehensive_async_test::nested_async_fn::{async_fn#0}
  2. comprehensive_async_test::standard_async_fn::{async_fn#0}
[rust-future-tracing] Step 4 complete. Ready to instrument 2 poll functions
[rust-future-tracing] Initialized AsyncBacktracePlugin for 2 poll functions.
[rust-future-tracing] === Step 5: Setting up instrumentation for poll functions ===
[rust-future-tracing] Processing future struct: {async_fn_env#0} at offset 409548
[rust-future-tracing] Ancestors: {406906: [409548, 411042], 407150: [409548, 411042], 409548: [411042]}
[rust-future-tracing] Processing future struct: {async_fn_env#0} at offset 406906
[rust-future-tracing] Ancestors: {406906: [409548, 411042], 407150: [409548, 411042], 409548: [411042]}
  - Will instrument: comprehensive_async_test::nested_async_fn::{async_fn#0}
  - Will instrument: comprehensive_async_test::standard_async_fn::{async_fn#0}
[rust-future-tracing] === Step 5 complete ===
[rust-future-tracing] Setting up entry breakpoint for: comprehensive_async_test::nested_async_fn::{async_fn#0}
[rust-future-tracing] Setting up entry breakpoint for: comprehensive_async_test::standard_async_fn::{async_fn#0}
[rust-future-tracing] All steps complete. Instrumentation is active.
Hint: Use 'continue' or 'run' to start the program, then 'inspect-async' to see results.
```

然后我发现下面这个内容有些奇怪，other DIEs是什么内容

```shell
[rust-future-tracing] Validation complete:
  - Async functions: 0
  - Future structs: 2
  - Other DIEs: 2
  - Invalid offsets: 0
```

以及为什么只找到两个poll函数，async_block_fn去哪了

```shell
[rust-future-tracing] Step 4 complete. Found 2 unique poll functions:
  1. comprehensive_async_test::nested_async_fn::{async_fn#0}
  2. comprehensive_async_test::standard_async_fn::{async_fn#0}
```

说明`__init__.py`的内容有问题，并且问题出在用于“验证”和“分类”DIE 的辅助函数上。上面找到的4个 Total expanded DIE offsets应该包括main、nested_async_fn、standard_async_fn、async_block_fn，修改完源代码的bug后，在重新进行调试跟踪，获得了下面的结果：

```shell
(gdb) start-async-debug 
[rust-future-tracing] Step 1: Reading user-selected interesting functions...
[rust-future-tracing] Found interesting poll function: static fn comprehensive_async_test::nested_async_fn::{async_fn#0}(*mut core::task::wake::Context)
[rust-future-tracing] Mapped static fn comprehensive_async_test::nested_async_fn::{async_fn#0}(*mut core::task::wake::Context) -> comprehensive_async_test::nested_async_fn::{async_fn_env#0} (DIE offset: 409548)
[rust-future-tracing] Found 1 interesting futures:
  - comprehensive_async_test::nested_async_fn::{async_fn_env#0}
[rust-future-tracing] === Step 3: Performing future expansion ===
[rust-future-tracing] Converting interesting futures to DIE offsets...
[rust-future-tracing] Converting future to DIE offset: comprehensive_async_test::nested_async_fn::{async_fn_env#0}
[rust-future-tracing] Mapped comprehensive_async_test::nested_async_fn::{async_fn_env#0} -> DIE offset: 409548
[rust-future-tracing] Expanding future dependencies...
[rust-future-tracing] Loaded async dependencies from /home/iristseng/data/rust-future-tracing/results/async_dependencies.json
[rust-future-tracing] Expanding dependencies for DIE offset: 0x63fcc
[rust-future-tracing] Expansion complete:
  - Total expanded DIE offsets: 4
  - Leaf futures (no dependencies): 3
  - Root futures (coroutines): 3
[rust-future-tracing] Validating expanded futures with DIE tree...
[rust-future-tracing] Validation complete:
  - Async functions: 0
  - Future structs: 4
  - Other DIEs: 0
  - Invalid offsets: 0
[rust-future-tracing] === Step 3 complete ===
[rust-future-tracing] Step 3 complete. Expanded to 4 total futures
[rust-future-tracing] === Step 4: Converting expanded futures to poll functions ===
[rust-future-tracing] Converting future to poll function: {async_block_env#0} (offset: 407150)
[rust-future-tracing] Mapped future -> poll: {async_block_env#0} -> comprehensive_async_test::async_block::{async_block#0} (DIE offset: 407041)
--Type <RET> for more, q to quit, c to continue without paging--c
[rust-future-tracing] Converting future to poll function: {async_block_env#0} (offset: 411042)
[rust-future-tracing] Mapped future -> poll: {async_block_env#0} -> comprehensive_async_test::main::{async_block#0} (DIE offset: 409942)
[rust-future-tracing] Converting future to poll function: {async_fn_env#0} (offset: 409548)
[rust-future-tracing] Mapped future -> poll: {async_fn_env#0} -> comprehensive_async_test::nested_async_fn::{async_fn#0} (DIE offset: 409306)
[rust-future-tracing] Converting future to poll function: {async_fn_env#0} (offset: 406906)
[rust-future-tracing] Mapped future -> poll: {async_fn_env#0} -> comprehensive_async_test::standard_async_fn::{async_fn#0} (DIE offset: 406797)
[rust-future-tracing] Step 4 complete. Found 4 unique poll functions:
  1. comprehensive_async_test::async_block::{async_block#0}
  2. comprehensive_async_test::main::{async_block#0}
  3. comprehensive_async_test::nested_async_fn::{async_fn#0}
  4. comprehensive_async_test::standard_async_fn::{async_fn#0}
[rust-future-tracing] Step 4 complete. Ready to instrument 4 poll functions
[rust-future-tracing] Initialized AsyncBacktracePlugin for 4 poll functions.
[rust-future-tracing] === Step 5: Setting up instrumentation for poll functions ===
[rust-future-tracing] Processing future struct: {async_block_env#0} at offset 407150
[rust-future-tracing] Ancestors: {406906: [409548, 411042], 407150: [409548, 411042], 409548: [411042]}
[rust-future-tracing] Processing future struct: {async_block_env#0} at offset 411042
[rust-future-tracing] Ancestors: {406906: [409548, 411042], 407150: [409548, 411042], 409548: [411042]}
[rust-future-tracing] Processing future struct: {async_fn_env#0} at offset 409548
[rust-future-tracing] Ancestors: {406906: [409548, 411042], 407150: [409548, 411042], 409548: [411042]}
[rust-future-tracing] Processing future struct: {async_fn_env#0} at offset 406906
[rust-future-tracing] Ancestors: {406906: [409548, 411042], 407150: [409548, 411042], 409548: [411042]}
  - Will instrument: comprehensive_async_test::async_block::{async_block#0}
  - Will instrument: comprehensive_async_test::main::{async_block#0}
  - Will instrument: comprehensive_async_test::nested_async_fn::{async_fn#0}
  - Will instrument: comprehensive_async_test::standard_async_fn::{async_fn#0}
[rust-future-tracing] === Step 5 complete ===
[rust-future-tracing] Setting up entry breakpoint for: comprehensive_async_test::async_block::{async_block#0}
[rust-future-tracing] Setting up entry breakpoint for: comprehensive_async_test::main::{async_block#0}
[rust-future-tracing] Setting up entry breakpoint for: comprehensive_async_test::nested_async_fn::{async_fn#0}
[rust-future-tracing] Setting up entry breakpoint for: comprehensive_async_test::standard_async_fn::{async_fn#0}
[rust-future-tracing] All steps complete. Instrumentation is active.
Hint: Use 'continue' or 'run' to start the program, then 'inspect-async' to see results.
(gdb) run
Starting program: /home/iristseng/data/rust-future-tracing/tests/comprehensive_async_test/target/debug/comprehensive_async_test 

This GDB supports auto-downloading debuginfo from the following URLs:
  <https://debuginfod.ubuntu.com>
Enable debuginfod for this session? (y or [n]) y
Debuginfod has been enabled.
To make this setting permanent, add 'set debuginfod enabled on' to .gdbinit.
Downloading separate debug info for system-supplied DSO at 0x7ffff7fc3000
[Thread debugging using libthread_db enabled]                                                                                   
Using host libthread_db library "/lib/x86_64-linux-gnu/libthread_db.so.1".
[New Thread 0x7ffff7a006c0 (LWP 28594)]
[New Thread 0x7ffff76006c0 (LWP 28595)]
开始测试各种异步实现方式

Thread 1 "comprehensive_a" hit Temporary breakpoint -15, comprehensive_async_test::main::{async_block#0} () at src/main.rs:109
109	#[tokio::main]
================================================================================
                            Asynchronous Backtraces
================================================================================
Process 28590:
  Thread 28590:
    Coroutine '{async_block_env#0}' (ID: 411042):
         comprehensive_async_test::main::{async_block_env#0}
================================================================================

Thread 1 "comprehensive_a" hit Temporary breakpoint -16, comprehensive_async_test::standard_async_fn::{async_fn#0} ()
    at src/main.rs:8
8	async fn standard_async_fn() -> i32 {
================================================================================
                            Asynchronous Backtraces
================================================================================
Process 28590:
  Thread 28590:
    Coroutine '{async_block_env#0}' (ID: 411042):
         comprehensive_async_test::main::{async_block_env#0}
        -> comprehensive_async_test::standard_async_fn::{async_fn_env#0}
================================================================================
================================================================================
                            Asynchronous Backtraces
================================================================================
Process 28590:
  Thread 28590:
    Coroutine '{async_block_env#0}' (ID: 411042):
         comprehensive_async_test::main::{async_block_env#0}
================================================================================
standard_async_fn result: 42
================================================================================
                            Asynchronous Backtraces
================================================================================
Process 28590:
  Thread 28590:
    Coroutine '{async_block_env#0}' (ID: 411042):
      Stack is empty.
================================================================================

Thread 1 "comprehensive_a" hit Temporary breakpoint -17, comprehensive_async_test::main::{async_block#0} () at src/main.rs:109
109	#[tokio::main]
================================================================================
                            Asynchronous Backtraces
================================================================================
Process 28590:
  Thread 28590:
    Coroutine '{async_block_env#0}' (ID: 411042):
         comprehensive_async_test::main::{async_block_env#0}
================================================================================

Thread 1 "comprehensive_a" hit Temporary breakpoint -21, comprehensive_async_test::async_block::{async_block#0} ()
    at src/main.rs:15
15	    async {
================================================================================
                            Asynchronous Backtraces
================================================================================
Process 28590:
  Thread 28590:
    Coroutine '{async_block_env#0}' (ID: 411042):
         comprehensive_async_test::main::{async_block_env#0}
        -> comprehensive_async_test::async_block::{async_block_env#0}
================================================================================
================================================================================
                            Asynchronous Backtraces
================================================================================
Process 28590:
  Thread 28590:
    Coroutine '{async_block_env#0}' (ID: 411042):
         comprehensive_async_test::main::{async_block_env#0}
================================================================================
async_block result: 100
================================================================================
                            Asynchronous Backtraces
================================================================================
Process 28590:
  Thread 28590:
    Coroutine '{async_block_env#0}' (ID: 411042):
      Stack is empty.
================================================================================

Thread 1 "comprehensive_a" hit Temporary breakpoint -22, comprehensive_async_test::main::{async_block#0} () at src/main.rs:109
109	#[tokio::main]
================================================================================
                            Asynchronous Backtraces
================================================================================
Process 28590:
  Thread 28590:
    Coroutine '{async_block_env#0}' (ID: 411042):
         comprehensive_async_test::main::{async_block_env#0}
================================================================================
boxed_future result: 200
================================================================================
                            Asynchronous Backtraces
================================================================================
Process 28590:
  Thread 28590:
    Coroutine '{async_block_env#0}' (ID: 411042):
      Stack is empty.
================================================================================

Thread 1 "comprehensive_a" hit Temporary breakpoint -26, comprehensive_async_test::main::{async_block#0} () at src/main.rs:109
109	#[tokio::main]
================================================================================
                            Asynchronous Backtraces
================================================================================
Process 28590:
  Thread 28590:
    Coroutine '{async_block_env#0}' (ID: 411042):
         comprehensive_async_test::main::{async_block_env#0}
================================================================================
async_trait result: 300
================================================================================
                            Asynchronous Backtraces
================================================================================
Process 28590:
  Thread 28590:
    Coroutine '{async_block_env#0}' (ID: 411042):
      Stack is empty.
================================================================================

Thread 1 "comprehensive_a" hit Temporary breakpoint -28, comprehensive_async_test::main::{async_block#0} () at src/main.rs:109
109	#[tokio::main]
================================================================================
                            Asynchronous Backtraces
================================================================================
Process 28590:
  Thread 28590:
    Coroutine '{async_block_env#0}' (ID: 411042):
         comprehensive_async_test::main::{async_block_env#0}
================================================================================
generic_async_fn result: 600
================================================================================
                            Asynchronous Backtraces
================================================================================
Process 28590:
  Thread 28590:
    Coroutine '{async_block_env#0}' (ID: 411042):
      Stack is empty.
================================================================================

Thread 1 "comprehensive_a" hit Temporary breakpoint -30, comprehensive_async_test::main::{async_block#0} () at src/main.rs:109
109	#[tokio::main]
================================================================================
                            Asynchronous Backtraces
================================================================================
Process 28590:
  Thread 28590:
    Coroutine '{async_block_env#0}' (ID: 411042):
         comprehensive_async_test::main::{async_block_env#0}
================================================================================
lifetime_async_fn result: hello
================================================================================
                            Asynchronous Backtraces
================================================================================
Process 28590:
  Thread 28590:
    Coroutine '{async_block_env#0}' (ID: 411042):
      Stack is empty.
================================================================================

Thread 1 "comprehensive_a" hit Temporary breakpoint -32, comprehensive_async_test::main::{async_block#0} () at src/main.rs:109
109	#[tokio::main]
================================================================================
                            Asynchronous Backtraces
================================================================================
Process 28590:
  Thread 28590:
    Coroutine '{async_block_env#0}' (ID: 411042):
         comprehensive_async_test::main::{async_block_env#0}
================================================================================
impl_async_fn result: 500
combinators_async_fn result: 1

Thread 1 "comprehensive_a" hit Temporary breakpoint -19, comprehensive_async_test::standard_async_fn::{async_fn#0} ()
    at src/main.rs:8
8	async fn standard_async_fn() -> i32 {
================================================================================
                            Asynchronous Backtraces
================================================================================
Process 28590:
  Thread 28590:
    Coroutine '{async_block_env#0}' (ID: 411042):
         comprehensive_async_test::main::{async_block_env#0}
        -> comprehensive_async_test::standard_async_fn::{async_fn_env#0}
================================================================================
================================================================================
                            Asynchronous Backtraces
================================================================================
Process 28590:
  Thread 28590:
    Coroutine '{async_block_env#0}' (ID: 411042):
         comprehensive_async_test::main::{async_block_env#0}
================================================================================
================================================================================
                            Asynchronous Backtraces
================================================================================
Process 28590:
  Thread 28590:
    Coroutine '{async_block_env#0}' (ID: 411042):
      Stack is empty.
================================================================================

Thread 1 "comprehensive_a" hit Temporary breakpoint -34, comprehensive_async_test::main::{async_block#0} () at src/main.rs:109
109	#[tokio::main]
================================================================================
                            Asynchronous Backtraces
================================================================================
Process 28590:
  Thread 28590:
    Coroutine '{async_block_env#0}' (ID: 411042):
         comprehensive_async_test::main::{async_block_env#0}
================================================================================

Thread 1 "comprehensive_a" hit Temporary breakpoint -36, comprehensive_async_test::nested_async_fn::{async_fn#0} ()
    at src/main.rs:102
102	async fn nested_async_fn() -> i32 {
================================================================================
                            Asynchronous Backtraces
================================================================================
Process 28590:
  Thread 28590:
    Coroutine '{async_block_env#0}' (ID: 411042):
         comprehensive_async_test::main::{async_block_env#0}
        -> comprehensive_async_test::nested_async_fn::{async_fn_env#0}
================================================================================

Thread 1 "comprehensive_a" hit Temporary breakpoint -37, comprehensive_async_test::standard_async_fn::{async_fn#0} ()
    at src/main.rs:8
8	async fn standard_async_fn() -> i32 {
================================================================================
                            Asynchronous Backtraces
================================================================================
Process 28590:
  Thread 28590:
    Coroutine '{async_block_env#0}' (ID: 411042):
         comprehensive_async_test::main::{async_block_env#0}
        -> comprehensive_async_test::nested_async_fn::{async_fn_env#0}
          -> comprehensive_async_test::standard_async_fn::{async_fn_env#0}
================================================================================
================================================================================
                            Asynchronous Backtraces
================================================================================
Process 28590:
  Thread 28590:
    Coroutine '{async_block_env#0}' (ID: 411042):
         comprehensive_async_test::main::{async_block_env#0}
        -> comprehensive_async_test::nested_async_fn::{async_fn_env#0}
================================================================================

Thread 1 "comprehensive_a" hit Temporary breakpoint -24, comprehensive_async_test::async_block::{async_block#0} ()
    at src/main.rs:15
15	    async {
================================================================================
                            Asynchronous Backtraces
================================================================================
Process 28590:
  Thread 28590:
    Coroutine '{async_block_env#0}' (ID: 411042):
         comprehensive_async_test::main::{async_block_env#0}
        -> comprehensive_async_test::nested_async_fn::{async_fn_env#0}
          -> comprehensive_async_test::async_block::{async_block_env#0}
================================================================================
================================================================================
                            Asynchronous Backtraces
================================================================================
Process 28590:
  Thread 28590:
    Coroutine '{async_block_env#0}' (ID: 411042):
         comprehensive_async_test::main::{async_block_env#0}
        -> comprehensive_async_test::nested_async_fn::{async_fn_env#0}
================================================================================
================================================================================
                            Asynchronous Backtraces
================================================================================
Process 28590:
  Thread 28590:
    Coroutine '{async_block_env#0}' (ID: 411042):
         comprehensive_async_test::main::{async_block_env#0}
================================================================================
================================================================================
                            Asynchronous Backtraces
================================================================================
Process 28590:
  Thread 28590:
    Coroutine '{async_block_env#0}' (ID: 411042):
      Stack is empty.
================================================================================

Thread 1 "comprehensive_a" hit Temporary breakpoint -39, comprehensive_async_test::main::{async_block#0} () at src/main.rs:109
109	#[tokio::main]
================================================================================
                            Asynchronous Backtraces
================================================================================
Process 28590:
  Thread 28590:
    Coroutine '{async_block_env#0}' (ID: 411042):
         comprehensive_async_test::main::{async_block_env#0}
================================================================================

Thread 1 "comprehensive_a" hit Temporary breakpoint -41, comprehensive_async_test::nested_async_fn::{async_fn#0} ()
    at src/main.rs:102
102	async fn nested_async_fn() -> i32 {
================================================================================
                            Asynchronous Backtraces
================================================================================
Process 28590:
  Thread 28590:
    Coroutine '{async_block_env#0}' (ID: 411042):
         comprehensive_async_test::main::{async_block_env#0}
        -> comprehensive_async_test::nested_async_fn::{async_fn_env#0}
================================================================================

Thread 1 "comprehensive_a" hit Temporary breakpoint -45, comprehensive_async_test::async_block::{async_block#0} ()
    at src/main.rs:15
15	    async {
================================================================================
                            Asynchronous Backtraces
================================================================================
Process 28590:
  Thread 28590:
    Coroutine '{async_block_env#0}' (ID: 411042):
         comprehensive_async_test::main::{async_block_env#0}
        -> comprehensive_async_test::nested_async_fn::{async_fn_env#0}
          -> comprehensive_async_test::async_block::{async_block_env#0}
================================================================================
================================================================================
                            Asynchronous Backtraces
================================================================================
Process 28590:
  Thread 28590:
    Coroutine '{async_block_env#0}' (ID: 411042):
         comprehensive_async_test::main::{async_block_env#0}
        -> comprehensive_async_test::nested_async_fn::{async_fn_env#0}
================================================================================
================================================================================
                            Asynchronous Backtraces
================================================================================
Process 28590:
  Thread 28590:
    Coroutine '{async_block_env#0}' (ID: 411042):
         comprehensive_async_test::main::{async_block_env#0}
================================================================================
nested_async_fn result: 142
所有测试完成
================================================================================
                            Asynchronous Backtraces
================================================================================
Process 28590:
  Thread 28590:
    Coroutine '{async_block_env#0}' (ID: 411042):
      Stack is empty.
================================================================================
[Thread 0x7ffff76006c0 (LWP 28595) exited]
[Thread 0x7ffff7a006c0 (LWP 28594) exited]
[Inferior 1 (process 28590) exited normally]
```

检查结果是没有问题的。

改完bug后重新测试前面无法跟踪的代码：

##### 异步块 {async_block# }

结果没问题。

```shell
(gdb) start-async-debug 
[rust-future-tracing] Step 1: Reading user-selected interesting functions...
[rust-future-tracing] Found interesting poll function: static fn comprehensive_async_test::async_block::{async_block#0}(*mut core::task::wake::Context)
[rust-future-tracing] Mapped static fn comprehensive_async_test::async_block::{async_block#0}(*mut core::task::wake::Context) -> comprehensive_async_test::async_block::{async_block_env#0} (DIE offset: 407150)
[rust-future-tracing] Found 1 interesting futures:
  - comprehensive_async_test::async_block::{async_block_env#0}
[rust-future-tracing] === Step 3: Performing future expansion ===
[rust-future-tracing] Converting interesting futures to DIE offsets...
[rust-future-tracing] Converting future to DIE offset: comprehensive_async_test::async_block::{async_block_env#0}
[rust-future-tracing] Mapped comprehensive_async_test::async_block::{async_block_env#0} -> DIE offset: 407150
[rust-future-tracing] Expanding future dependencies...
[rust-future-tracing] Loaded async dependencies from /home/iristseng/data/rust-future-tracing/results/async_dependencies.json
[rust-future-tracing] Expanding dependencies for DIE offset: 0x6366e
[rust-future-tracing] Expansion complete:
  - Total expanded DIE offsets: 3
  - Leaf futures (no dependencies): 1
  - Root futures (coroutines): 3
[rust-future-tracing] Validating expanded futures with DIE tree...
[rust-future-tracing] Validation complete:
  - Async functions: 0
  - Future structs: 3
  - Other DIEs: 0
  - Invalid offsets: 0
[rust-future-tracing] === Step 3 complete ===
[rust-future-tracing] Step 3 complete. Expanded to 3 total futures
[rust-future-tracing] === Step 4: Converting expanded futures to poll functions ===
[rust-future-tracing] Converting future to poll function: {async_block_env#0} (offset: 411042)
[rust-future-tracing] Mapped future -> poll: {async_block_env#0} -> comprehensive_async_test::main::{async_block#0} (DIE offset: 409942)
--Type <RET> for more, q to quit, c to continue without paging--c
[rust-future-tracing] Converting future to poll function: {async_fn_env#0} (offset: 409548)
[rust-future-tracing] Mapped future -> poll: {async_fn_env#0} -> comprehensive_async_test::nested_async_fn::{async_fn#0} (DIE offset: 409306)
[rust-future-tracing] Converting future to poll function: {async_block_env#0} (offset: 407150)
[rust-future-tracing] Mapped future -> poll: {async_block_env#0} -> comprehensive_async_test::async_block::{async_block#0} (DIE offset: 407041)
[rust-future-tracing] Step 4 complete. Found 3 unique poll functions:
  1. comprehensive_async_test::main::{async_block#0}
  2. comprehensive_async_test::nested_async_fn::{async_fn#0}
  3. comprehensive_async_test::async_block::{async_block#0}
[rust-future-tracing] Step 4 complete. Ready to instrument 3 poll functions
[rust-future-tracing] Initialized AsyncBacktracePlugin for 3 poll functions.
[rust-future-tracing] === Step 5: Setting up instrumentation for poll functions ===
[rust-future-tracing] Processing future struct: {async_block_env#0} at offset 411042
[rust-future-tracing] Ancestors: {407150: [409548, 411042], 409548: [411042]}
[rust-future-tracing] Processing future struct: {async_fn_env#0} at offset 409548
[rust-future-tracing] Ancestors: {407150: [409548, 411042], 409548: [411042]}
[rust-future-tracing] Processing future struct: {async_block_env#0} at offset 407150
[rust-future-tracing] Ancestors: {407150: [409548, 411042], 409548: [411042]}
  - Will instrument: comprehensive_async_test::main::{async_block#0}
  - Will instrument: comprehensive_async_test::nested_async_fn::{async_fn#0}
  - Will instrument: comprehensive_async_test::async_block::{async_block#0}
[rust-future-tracing] === Step 5 complete ===
[rust-future-tracing] Setting up entry breakpoint for: comprehensive_async_test::main::{async_block#0}
[rust-future-tracing] Setting up entry breakpoint for: comprehensive_async_test::nested_async_fn::{async_fn#0}
[rust-future-tracing] Setting up entry breakpoint for: comprehensive_async_test::async_block::{async_block#0}
[rust-future-tracing] All steps complete. Instrumentation is active.
Hint: Use 'continue' or 'run' to start the program, then 'inspect-async' to see results.
(gdb) run
Starting program: /home/iristseng/data/rust-future-tracing/tests/comprehensive_async_test/target/debug/comprehensive_async_test 

This GDB supports auto-downloading debuginfo from the following URLs:
  <https://debuginfod.ubuntu.com>
Enable debuginfod for this session? (y or [n]) y
Debuginfod has been enabled.
To make this setting permanent, add 'set debuginfod enabled on' to .gdbinit.
Downloading separate debug info for system-supplied DSO at 0x7ffff7fc3000
[Thread debugging using libthread_db enabled]                                                                                   
Using host libthread_db library "/lib/x86_64-linux-gnu/libthread_db.so.1".
[New Thread 0x7ffff7a006c0 (LWP 29493)]
[New Thread 0x7ffff76006c0 (LWP 29494)]
开始测试各种异步实现方式

Thread 1 "comprehensive_a" hit Temporary breakpoint -14, comprehensive_async_test::main::{async_block#0} () at src/main.rs:109
109	#[tokio::main]
================================================================================
                            Asynchronous Backtraces
================================================================================
Process 29489:
  Thread 29489:
    Coroutine '{async_block_env#0}' (ID: 411042):
         comprehensive_async_test::main::{async_block_env#0}
================================================================================
standard_async_fn result: 42
================================================================================
                            Asynchronous Backtraces
================================================================================
Process 29489:
  Thread 29489:
    Coroutine '{async_block_env#0}' (ID: 411042):
      Stack is empty.
================================================================================

Thread 1 "comprehensive_a" hit Temporary breakpoint -15, comprehensive_async_test::main::{async_block#0} () at src/main.rs:109
109	#[tokio::main]
================================================================================
                            Asynchronous Backtraces
================================================================================
Process 29489:
  Thread 29489:
    Coroutine '{async_block_env#0}' (ID: 411042):
         comprehensive_async_test::main::{async_block_env#0}
================================================================================

Thread 1 "comprehensive_a" hit Temporary breakpoint -17, comprehensive_async_test::async_block::{async_block#0} ()
    at src/main.rs:15
15	    async {
================================================================================
                            Asynchronous Backtraces
================================================================================
Process 29489:
  Thread 29489:
    Coroutine '{async_block_env#0}' (ID: 411042):
         comprehensive_async_test::main::{async_block_env#0}
        -> comprehensive_async_test::async_block::{async_block_env#0}
================================================================================
================================================================================
                            Asynchronous Backtraces
================================================================================
Process 29489:
  Thread 29489:
    Coroutine '{async_block_env#0}' (ID: 411042):
         comprehensive_async_test::main::{async_block_env#0}
================================================================================
async_block result: 100
================================================================================
                            Asynchronous Backtraces
================================================================================
Process 29489:
  Thread 29489:
    Coroutine '{async_block_env#0}' (ID: 411042):
      Stack is empty.
================================================================================

Thread 1 "comprehensive_a" hit Temporary breakpoint -18, comprehensive_async_test::main::{async_block#0} () at src/main.rs:109
109	#[tokio::main]
================================================================================
                            Asynchronous Backtraces
================================================================================
Process 29489:
  Thread 29489:
    Coroutine '{async_block_env#0}' (ID: 411042):
         comprehensive_async_test::main::{async_block_env#0}
================================================================================
boxed_future result: 200
================================================================================
                            Asynchronous Backtraces
================================================================================
Process 29489:
  Thread 29489:
    Coroutine '{async_block_env#0}' (ID: 411042):
      Stack is empty.
================================================================================

Thread 1 "comprehensive_a" hit Temporary breakpoint -22, comprehensive_async_test::main::{async_block#0} () at src/main.rs:109
109	#[tokio::main]
================================================================================
                            Asynchronous Backtraces
================================================================================
Process 29489:
  Thread 29489:
    Coroutine '{async_block_env#0}' (ID: 411042):
         comprehensive_async_test::main::{async_block_env#0}
================================================================================
async_trait result: 300
================================================================================
                            Asynchronous Backtraces
================================================================================
Process 29489:
  Thread 29489:
    Coroutine '{async_block_env#0}' (ID: 411042):
      Stack is empty.
================================================================================

Thread 1 "comprehensive_a" hit Temporary breakpoint -24, comprehensive_async_test::main::{async_block#0} () at src/main.rs:109
109	#[tokio::main]
================================================================================
                            Asynchronous Backtraces
================================================================================
Process 29489:
  Thread 29489:
    Coroutine '{async_block_env#0}' (ID: 411042):
         comprehensive_async_test::main::{async_block_env#0}
================================================================================
generic_async_fn result: 600
================================================================================
                            Asynchronous Backtraces
================================================================================
Process 29489:
  Thread 29489:
    Coroutine '{async_block_env#0}' (ID: 411042):
      Stack is empty.
================================================================================

Thread 1 "comprehensive_a" hit Temporary breakpoint -26, comprehensive_async_test::main::{async_block#0} () at src/main.rs:109
109	#[tokio::main]
================================================================================
                            Asynchronous Backtraces
================================================================================
Process 29489:
  Thread 29489:
    Coroutine '{async_block_env#0}' (ID: 411042):
         comprehensive_async_test::main::{async_block_env#0}
================================================================================
lifetime_async_fn result: hello
================================================================================
                            Asynchronous Backtraces
================================================================================
Process 29489:
  Thread 29489:
    Coroutine '{async_block_env#0}' (ID: 411042):
      Stack is empty.
================================================================================

Thread 1 "comprehensive_a" hit Temporary breakpoint -28, comprehensive_async_test::main::{async_block#0} () at src/main.rs:109
109	#[tokio::main]
================================================================================
                            Asynchronous Backtraces
================================================================================
Process 29489:
  Thread 29489:
    Coroutine '{async_block_env#0}' (ID: 411042):
         comprehensive_async_test::main::{async_block_env#0}
================================================================================
impl_async_fn result: 500
combinators_async_fn result: 1
================================================================================
                            Asynchronous Backtraces
================================================================================
Process 29489:
  Thread 29489:
    Coroutine '{async_block_env#0}' (ID: 411042):
      Stack is empty.
================================================================================

Thread 1 "comprehensive_a" hit Temporary breakpoint -30, comprehensive_async_test::main::{async_block#0} () at src/main.rs:109
109	#[tokio::main]
================================================================================
                            Asynchronous Backtraces
================================================================================
Process 29489:
  Thread 29489:
    Coroutine '{async_block_env#0}' (ID: 411042):
         comprehensive_async_test::main::{async_block_env#0}
================================================================================

Thread 1 "comprehensive_a" hit Temporary breakpoint -32, comprehensive_async_test::nested_async_fn::{async_fn#0} ()
    at src/main.rs:102
102	async fn nested_async_fn() -> i32 {
================================================================================
                            Asynchronous Backtraces
================================================================================
Process 29489:
  Thread 29489:
    Coroutine '{async_block_env#0}' (ID: 411042):
         comprehensive_async_test::main::{async_block_env#0}
        -> comprehensive_async_test::nested_async_fn::{async_fn_env#0}
================================================================================

Thread 1 "comprehensive_a" hit Temporary breakpoint -20, comprehensive_async_test::async_block::{async_block#0} ()
    at src/main.rs:15
15	    async {
================================================================================
                            Asynchronous Backtraces
================================================================================
Process 29489:
  Thread 29489:
    Coroutine '{async_block_env#0}' (ID: 411042):
         comprehensive_async_test::main::{async_block_env#0}
        -> comprehensive_async_test::nested_async_fn::{async_fn_env#0}
          -> comprehensive_async_test::async_block::{async_block_env#0}
================================================================================
================================================================================
                            Asynchronous Backtraces
================================================================================
Process 29489:
  Thread 29489:
    Coroutine '{async_block_env#0}' (ID: 411042):
         comprehensive_async_test::main::{async_block_env#0}
        -> comprehensive_async_test::nested_async_fn::{async_fn_env#0}
================================================================================
================================================================================
                            Asynchronous Backtraces
================================================================================
Process 29489:
  Thread 29489:
    Coroutine '{async_block_env#0}' (ID: 411042):
         comprehensive_async_test::main::{async_block_env#0}
================================================================================
================================================================================
                            Asynchronous Backtraces
================================================================================
Process 29489:
  Thread 29489:
    Coroutine '{async_block_env#0}' (ID: 411042):
      Stack is empty.
================================================================================

Thread 1 "comprehensive_a" hit Temporary breakpoint -33, comprehensive_async_test::main::{async_block#0} () at src/main.rs:109
109	#[tokio::main]
================================================================================
                            Asynchronous Backtraces
================================================================================
Process 29489:
  Thread 29489:
    Coroutine '{async_block_env#0}' (ID: 411042):
         comprehensive_async_test::main::{async_block_env#0}
================================================================================

Thread 1 "comprehensive_a" hit Temporary breakpoint -35, comprehensive_async_test::nested_async_fn::{async_fn#0} ()
    at src/main.rs:102
102	async fn nested_async_fn() -> i32 {
================================================================================
                            Asynchronous Backtraces
================================================================================
Process 29489:
  Thread 29489:
    Coroutine '{async_block_env#0}' (ID: 411042):
         comprehensive_async_test::main::{async_block_env#0}
        -> comprehensive_async_test::nested_async_fn::{async_fn_env#0}
================================================================================

Thread 1 "comprehensive_a" hit Temporary breakpoint -37, comprehensive_async_test::async_block::{async_block#0} ()
    at src/main.rs:15
15	    async {
================================================================================
                            Asynchronous Backtraces
================================================================================
Process 29489:
  Thread 29489:
    Coroutine '{async_block_env#0}' (ID: 411042):
         comprehensive_async_test::main::{async_block_env#0}
        -> comprehensive_async_test::nested_async_fn::{async_fn_env#0}
          -> comprehensive_async_test::async_block::{async_block_env#0}
================================================================================
================================================================================
                            Asynchronous Backtraces
================================================================================
Process 29489:
  Thread 29489:
    Coroutine '{async_block_env#0}' (ID: 411042):
         comprehensive_async_test::main::{async_block_env#0}
        -> comprehensive_async_test::nested_async_fn::{async_fn_env#0}
================================================================================
================================================================================
                            Asynchronous Backtraces
================================================================================
Process 29489:
  Thread 29489:
    Coroutine '{async_block_env#0}' (ID: 411042):
         comprehensive_async_test::main::{async_block_env#0}
================================================================================
nested_async_fn result: 142
所有测试完成
================================================================================
                            Asynchronous Backtraces
================================================================================
Process 29489:
  Thread 29489:
    Coroutine '{async_block_env#0}' (ID: 411042):
      Stack is empty.
================================================================================
[Thread 0x7ffff76006c0 (LWP 29494) exited]
[Thread 0x7ffff7a006c0 (LWP 29493) exited]
[Inferior 1 (process 29489) exited normally]
```

##### 手动实现 Future trait

报错如下：

```shell
(gdb) start-async-debug 
[rust-future-tracing] Step 1: Reading user-selected interesting functions...
[rust-future-tracing] Found interesting poll function: static fn comprehensive_async_test::{impl#0}::poll(core::pin::Pin<&mut comprehensive_async_test::ManualFuture>, *mut core::task::wake::Context)
[rust-future-tracing] No matches found for hierarchy: ['comprehensive_async_test', '{impl#0}', 'poll']
[rust-future-tracing] Warning: Could not convert poll function to future: static fn comprehensive_async_test::{impl#0}::poll(core::pin::Pin<&mut comprehensive_async_test::ManualFuture>, *mut core::task::wake::Context)
[rust-future-tracing] No interesting functions found. Please mark functions with 'async_backtrace': true in poll_map.json
```

遇到的这个问题，触及了我们这个 GDB 脚本设计的**核心假设边界**。简单来说，这个脚本被设计用来追踪由 `async fn` 和 `async {}` 语法糖**自动生成的 Future**，但它无法处理**手动实现的 Future**（即 `impl Future for YourStruct`）。

`ManualFuture` 的 `poll` 函数之所以跟踪不了，主要有两个根本原因，都与 DWARF 信息中的结构差异有关：

1. DWARF 结构完全不同，不存在“兄弟关系”

我们脚本的核心功能 `pollToFuture` 和 `futureToPoll` 依赖于一个关键假设：`poll` 函数 (`...::{async_fn#0}`) 和它对应的 `Future` 状态机 (`...::{async_fn_env#0}`) 在 DWARF 树中是**兄弟节点**，拥有共同的父节点。

- **对于 `async fn` (脚本能处理的情况):**

	```
	DW_TAG_namespace (名为 a_standard_async_fn)
	|
	|--- DW_TAG_subprogram (名为 {async_fn#0}, 这是 poll 函数)
	|
	+--- DW_TAG_structure_type (名为 {async_fn_env#0}, 这是 Future 状态机)
	```

	脚本可以通过 `_find_sibling_...` 函数找到这种关系。

- **对于 `ManualFuture` (脚本无法处理的情况):**

	```
	DW_TAG_structure_type (名为 ManualFuture, 这本身就是 Future)
	|
	+--- DW_TAG_implementation (为 ManualFuture 实现 Future trait)
	     |
	     +--- DW_TAG_subprogram (名为 poll, 这是 poll 函数)
	```

	在这里，`poll` 函数是 `ManualFuture` 结构体的“孙子”节点，而不是“兄弟”节点。因此，脚本的 `_find_sibling_poll_function` 和 `_find_sibling_future_struct` 函数在这种结构下完全找不到任何东西。



2. 命名约定完全不匹配

脚本的另一个核心假设是 `poll` 函数和 `Future` 结构体之间存在着可预测的命名关系：

- `poll` 函数名包含 `{async_fn#...}` 或 `{async_block#...}`
- `Future` 结构体名包含 `{async_fn_env#...}` 或 `{async_block_env#...}`

脚本通过正则表达式从一个名字中提取出“基础名称”和“编号”，然后构造出另一个的名字。

但在 `ManualFuture` 的例子中：

- `poll` 函数的名字就是 `poll`。
- `Future` 结构体的名字是 `ManualFuture`。

这两个名字之间**没有任何程序化的关联性**。脚本无法从 `poll` 这个名字推断出它属于 `ManualFuture`，反之亦然。

1. `Found interesting poll function: static fn comprehensive_async_test::{impl#0}::poll(...)`
	- 您的 `poll_map.json` 正确地将 `ManualFuture::poll` 函数标记为兴趣点。GDB 识别出的函数名是 `...::{impl#0}::poll`，这是 `impl Future for ManualFuture` 的内部表示。
2. `No matches found for hierarchy: ['comprehensive_async_test', '{impl#0}', 'poll']`
	- 脚本尝试在 DWARF 树中按层级查找这个函数，但因为我们上面分析的 DWARF 结构差异，这个简单的层级搜索失败了。它没能找到这个 `poll` 函数的 DIE。
3. `Warning: Could not convert poll function to future: ...`
	- 因为上一步连 `poll` 函数的 DIE 都没找到，所以 `pollToFuture` 自然就失败了，无法将其转换为一个 Future。
4. `No interesting functions found. ...`
	- 最终，因为唯一的兴趣点转换失败，脚本认为没有有效的追踪目标，于是提前退出了。



要支持手动实现的 Future，需要对 GDB 脚本进行重大的架构性修改，例如：

- 放弃“兄弟查找”逻辑，改为更复杂的、能够理解 `DW_TAG_implementation` 的 DWARF 树遍历。
- 通过分析 `poll` 函数的 `self` 参数类型（例如 `Pin<&mut comprehensive_async_test::ManualFuture>`），来反向推断它所属的 Future 结构体。这在技术上非常复杂。

尝试了第二种方法，但是`ManualFuture::poll` 的 DWARF 结构比我们想象的还要复杂和特殊，self` 参数分析也未能成功解包。我决定暂时搁置这个边缘、复杂的情况。

##### 通过 Box 包装的 Future

返回结果：

```shell
(gdb) start-async-debug 
[rust-future-tracing] Step 1: Reading user-selected interesting functions...
[rust-future-tracing] Found interesting poll function: static fn comprehensive_async_test::boxed_future::{async_block#0}(*mut core::task::wake::Context)
[rust-future-tracing] No future struct found for poll function at offset: 407285
[rust-future-tracing] No future structs found for poll function: static fn comprehensive_async_test::boxed_future::{async_block#0}(*mut core::task::wake::Context)
[rust-future-tracing] Warning: Could not convert poll function to future: static fn comprehensive_async_test::boxed_future::{async_block#0}(*mut core::task::wake::Context)
[rust-future-tracing] No interesting functions found. Please mark functions with 'async_backtrace': true in poll_map.json
```

跟踪失败的原因：

 `boxed_future` 恰好触及了静态 DWARF 分析中最困难的领域之一：**类型擦除 (Type Erasure) 和 Trait 对象**。

这和我们之前遇到的 `ManualFuture` 的情况又有所不同，但同样暴露了脚本设计中的一个深层假设。问题的根源：被“抹去”的类型与被打破的 DWARF 结构

让我们看一下 `boxed_future` 的代码：

```Rust
fn boxed_future() -> Pin<Box<dyn Future<Output = i32>>> {
    Box::pin(async {
        // ...
    })
}
```

这里的关键是返回值类型 `Pin<Box<dyn Future<...>>>`。

1. **发生了什么**：
	- `async { ... }` 这部分代码确实创建了一个由编译器生成的、匿名的、具体的 Future 状态机结构体（我们称之为 `ConcreteFuture`），以及它对应的 `poll` 函数。
	- 但是，`Box::pin` 立即将这个 `ConcreteFuture` 实例放到了堆上，并将其转换为一个 **Trait 对象** `Box<dyn Future>`。
	- 在这个转换过程中，`ConcreteFuture` 这个**具体的类型信息就被“抹去”了**。从 `boxed_future` 函数外部来看，调用者只知道它返回了一个“实现了 `Future` trait 的东西”，但不知道这个东西的具体类型是什么。
2. **这对 DWARF 造成了什么影响**：
	- 对于一个普通的 `async fn my_func()`，编译器会创建一个清晰的命名空间 `my_func`，然后把对应的 `poll` 函数 (`{async_fn#0}`) 和 `Future` 结构体 (`{async_fn_env#0}`) 作为**兄弟节点**并排放在里面。它们的关联关系非常明确。
	- 但对于 `Box::pin(async { ... })`，这个 `async` 块是匿名的，它的唯一目的就是被立即转换成一个 Trait 对象。编译器在这种情况下，生成的 DWARF 信息可能会比较“随意”。它依然会生成 `poll` 函数和 `Future` 结构体的 DIE，但**它们之间清晰的、可预测的“兄弟”层级关系很可能被打破了**。它们可能被放在一些更通用的、由编译器管理的内部命名空间下，彼此之间不再是直接的邻居。

现在我们来看日志，就完全说得通了：

1. `Found interesting poll function: ...::boxed_future::{async_block#0}`
	- 脚本成功地在 DWARF 中找到了 `async` 块对应的那个 `poll` 函数的 DIE。**这一步是成功的**。
2. `No future struct found for poll function at offset: 407285`
	- 这是 `pollToFuture` 转换失败的核心。它拿着 `poll` 函数的 DIE（在 offset `407285`），开始尝试寻找对应的 `Future` 结构体。
	- 它首先尝试**策略一：`_find_sibling_future_struct`**。它去 `poll` 函数的父节点下寻找一个名字匹配的 `_env` 结构体兄弟。但正如我们分析的，因为类型擦除，这种清晰的兄弟关系很可能不存在了，所以查找失败。
	- 然后它尝试**策略二：`_find_future_struct_from_poll_self_param`**。但这个策略是为手动 `impl Future` 设计的，它寻找的是一个名为 `poll` 且有 `self` 参数的函数。编译器为 `async` 块生成的 `poll` 函数（名为 `{async_block#0}`）的结构与此不同，所以这个后备策略也失败了。
3. `Warning: Could not convert ...` & `No interesting functions found ...`
	- 因为两个策略都失败了，`pollToFuture` 最终返回 `None`，导致整个追踪流程无法继续。

总而言之，`boxed_future` 无法被追踪，是因为 **`Box<dyn Future>` 的类型擦除机制，破坏了编译器通常会为 `async` 代码生成的、可预测的 DWARF 结构**。

##### 使用 async-trait 的 trait

也同样是无法跟踪：

这个问题的根源和我们刚刚分析的 `boxed_future` **是完全一样的**，只是它隐藏得更深。罪魁祸首是 `#[async_trait]` 这个宏。

在目前的稳定版 Rust 中，`async fn` 不能直接用在 trait 的定义中。`async_trait` 是一个非常流行的第三方库，它通过**代码生成**（宏）巧妙地绕过了这个限制。

当写下这样的代码时：

```rust
#[async_trait]
trait AsyncTrait {
    async fn async_method(&self) -> i32;
}

#[async_trait]
impl AsyncTrait for TraitImpl {
    async fn async_method(&self) -> i32 {
        // ...
    }
}
`#[async_trait]` 宏会在编译时，自动地将您的代码**重写**成类似下面这样的、不包含 `async fn` 的普通 Rust 代码：
```

```rust
// 这是 async_trait 宏转换后的大致样子

trait AsyncTrait {
    // async fn 被转换成一个返回 Box<dyn Future> 的普通函数
    fn async_method(&self) -> core::pin::Pin<Box<dyn core::future::Future<Output = i32> + Send>>;
}

impl AsyncTrait for TraitImpl {
    fn async_method(&self) -> core::pin::Pin<Box<dyn core::future::Future<Output = i32> + Send>> {
        // 您写的 async 函数体被放进一个 async 块，然后用 Box::pin 包装起来
        Box::pin(async move {
            // ...
        })
    }
}
```

经过宏的转换，`async_trait` 的实现**本质上就变成了一个返回 `Box<dyn Future>` 的函数**——这与我们上一个 `boxed_future` 的例子在底层是完全一样的。

##### 泛型 async fn

跟踪结果没问题：

```shell
(gdb) start-async-debug 
[rust-future-tracing] Step 1: Reading user-selected interesting functions...
[rust-future-tracing] Found interesting poll function: static fn comprehensive_async_test::generic_async_fn::{async_fn#0}<i32>(*mut core::task::wake::Context)
[rust-future-tracing] Mapped static fn comprehensive_async_test::generic_async_fn::{async_fn#0}<i32>(*mut core::task::wake::Context) -> comprehensive_async_test::generic_async_fn::{async_fn_env#0}<i32> (DIE offset: 407613)
[rust-future-tracing] Found 1 interesting futures:
  - comprehensive_async_test::generic_async_fn::{async_fn_env#0}<i32>
[rust-future-tracing] === Step 3: Performing future expansion ===
[rust-future-tracing] Converting interesting futures to DIE offsets...
[rust-future-tracing] Converting future to DIE offset: comprehensive_async_test::generic_async_fn::{async_fn_env#0}<i32>
[rust-future-tracing] Mapped comprehensive_async_test::generic_async_fn::{async_fn_env#0}<i32> -> DIE offset: 407613
[rust-future-tracing] Expanding future dependencies...
[rust-future-tracing] Loaded async dependencies from /home/iristseng/data/rust-future-tracing/results/async_dependencies.json
[rust-future-tracing] Expanding dependencies for DIE offset: 0x6383d
[rust-future-tracing] Expansion complete:
  - Total expanded DIE offsets: 2
  - Leaf futures (no dependencies): 1
  - Root futures (coroutines): 2
[rust-future-tracing] Validating expanded futures with DIE tree...
[rust-future-tracing] Validation complete:
  - Async functions: 0
  - Future structs: 2
  - Other DIEs: 0
  - Invalid offsets: 0
[rust-future-tracing] === Step 3 complete ===
[rust-future-tracing] Step 3 complete. Expanded to 2 total futures
[rust-future-tracing] === Step 4: Converting expanded futures to poll functions ===
[rust-future-tracing] Converting future to poll function: {async_block_env#0} (offset: 411042)
[rust-future-tracing] Mapped future -> poll: {async_block_env#0} -> comprehensive_async_test::main::{async_block#0} (DIE offset: 409942)
--Type <RET> for more, q to quit, c to continue without paging--c
[rust-future-tracing] Converting future to poll function: {async_fn_env#0}<i32> (offset: 407613)
[rust-future-tracing] Mapped future -> poll: {async_fn_env#0}<i32> -> comprehensive_async_test::generic_async_fn::{async_fn#0}<i32> (DIE offset: 407453)
[rust-future-tracing] Step 4 complete. Found 2 unique poll functions:
  1. comprehensive_async_test::main::{async_block#0}
  2. comprehensive_async_test::generic_async_fn::{async_fn#0}<i32>
[rust-future-tracing] Step 4 complete. Ready to instrument 2 poll functions
[rust-future-tracing] Initialized AsyncBacktracePlugin for 2 poll functions.
[rust-future-tracing] === Step 5: Setting up instrumentation for poll functions ===
[rust-future-tracing] Processing future struct: {async_block_env#0} at offset 411042
[rust-future-tracing] Ancestors: {407613: [411042]}
[rust-future-tracing] Processing future struct: {async_fn_env#0}<i32> at offset 407613
[rust-future-tracing] Ancestors: {407613: [411042]}
  - Will instrument: comprehensive_async_test::main::{async_block#0}
  - Will instrument: comprehensive_async_test::generic_async_fn::{async_fn#0}<i32>
[rust-future-tracing] === Step 5 complete ===
[rust-future-tracing] Setting up entry breakpoint for: comprehensive_async_test::main::{async_block#0}
[rust-future-tracing] Setting up entry breakpoint for: comprehensive_async_test::generic_async_fn::{async_fn#0}<i32>
[rust-future-tracing] All steps complete. Instrumentation is active.
Hint: Use 'continue' or 'run' to start the program, then 'inspect-async' to see results.
(gdb) run
Starting program: /home/iristseng/data/rust-future-tracing/tests/comprehensive_async_test/target/debug/comprehensive_async_test 

This GDB supports auto-downloading debuginfo from the following URLs:
  <https://debuginfod.ubuntu.com>
Enable debuginfod for this session? (y or [n]) y
Debuginfod has been enabled.
To make this setting permanent, add 'set debuginfod enabled on' to .gdbinit.
Downloading separate debug info for system-supplied DSO at 0x7ffff7fc3000
[Thread debugging using libthread_db enabled]                                                                                   
Using host libthread_db library "/lib/x86_64-linux-gnu/libthread_db.so.1".
[New Thread 0x7ffff7a006c0 (LWP 31467)]
[New Thread 0x7ffff76006c0 (LWP 31468)]
开始测试各种异步实现方式

Thread 1 "comprehensive_a" hit Temporary breakpoint -13, comprehensive_async_test::main::{async_block#0} () at src/main.rs:109
109	#[tokio::main]
================================================================================
                            Asynchronous Backtraces
================================================================================
Process 31463:
  Thread 31463:
    Coroutine '{async_block_env#0}' (ID: 411042):
         comprehensive_async_test::main::{async_block_env#0}
================================================================================
standard_async_fn result: 42
================================================================================
                            Asynchronous Backtraces
================================================================================
Process 31463:
  Thread 31463:
    Coroutine '{async_block_env#0}' (ID: 411042):
      Stack is empty.
================================================================================

Thread 1 "comprehensive_a" hit Temporary breakpoint -14, comprehensive_async_test::main::{async_block#0} () at src/main.rs:109
109	#[tokio::main]
================================================================================
                            Asynchronous Backtraces
================================================================================
Process 31463:
  Thread 31463:
    Coroutine '{async_block_env#0}' (ID: 411042):
         comprehensive_async_test::main::{async_block_env#0}
================================================================================
async_block result: 100
================================================================================
                            Asynchronous Backtraces
================================================================================
Process 31463:
  Thread 31463:
    Coroutine '{async_block_env#0}' (ID: 411042):
      Stack is empty.
================================================================================

Thread 1 "comprehensive_a" hit Temporary breakpoint -16, comprehensive_async_test::main::{async_block#0} () at src/main.rs:109
109	#[tokio::main]
================================================================================
                            Asynchronous Backtraces
================================================================================
Process 31463:
  Thread 31463:
    Coroutine '{async_block_env#0}' (ID: 411042):
         comprehensive_async_test::main::{async_block_env#0}
================================================================================
boxed_future result: 200
================================================================================
                            Asynchronous Backtraces
================================================================================
Process 31463:
  Thread 31463:
    Coroutine '{async_block_env#0}' (ID: 411042):
      Stack is empty.
================================================================================

Thread 1 "comprehensive_a" hit Temporary breakpoint -18, comprehensive_async_test::main::{async_block#0} () at src/main.rs:109
109	#[tokio::main]
================================================================================
                            Asynchronous Backtraces
================================================================================
Process 31463:
  Thread 31463:
    Coroutine '{async_block_env#0}' (ID: 411042):
         comprehensive_async_test::main::{async_block_env#0}
================================================================================
async_trait result: 300
================================================================================
                            Asynchronous Backtraces
================================================================================
Process 31463:
  Thread 31463:
    Coroutine '{async_block_env#0}' (ID: 411042):
      Stack is empty.
================================================================================

Thread 1 "comprehensive_a" hit Temporary breakpoint -20, comprehensive_async_test::main::{async_block#0} () at src/main.rs:109
109	#[tokio::main]
================================================================================
                            Asynchronous Backtraces
================================================================================
Process 31463:
  Thread 31463:
    Coroutine '{async_block_env#0}' (ID: 411042):
         comprehensive_async_test::main::{async_block_env#0}
================================================================================

Thread 1 "comprehensive_a" hit Temporary breakpoint -22, comprehensive_async_test::generic_async_fn::{async_fn#0}<i32> ()
    at src/main.rs:68
68	async fn generic_async_fn<T>(value: T) -> T {
================================================================================
                            Asynchronous Backtraces
================================================================================
Process 31463:
  Thread 31463:
    Coroutine '{async_block_env#0}' (ID: 411042):
         comprehensive_async_test::main::{async_block_env#0}
        -> comprehensive_async_test::generic_async_fn::{async_fn_env#0}<i32>
================================================================================
================================================================================
                            Asynchronous Backtraces
================================================================================
Process 31463:
  Thread 31463:
    Coroutine '{async_block_env#0}' (ID: 411042):
         comprehensive_async_test::main::{async_block_env#0}
================================================================================
generic_async_fn result: 600
================================================================================
                            Asynchronous Backtraces
================================================================================
Process 31463:
  Thread 31463:
    Coroutine '{async_block_env#0}' (ID: 411042):
      Stack is empty.
================================================================================

Thread 1 "comprehensive_a" hit Temporary breakpoint -23, comprehensive_async_test::main::{async_block#0} () at src/main.rs:109
109	#[tokio::main]
================================================================================
                            Asynchronous Backtraces
================================================================================
Process 31463:
  Thread 31463:
    Coroutine '{async_block_env#0}' (ID: 411042):
         comprehensive_async_test::main::{async_block_env#0}
================================================================================
lifetime_async_fn result: hello
================================================================================
                            Asynchronous Backtraces
================================================================================
Process 31463:
  Thread 31463:
    Coroutine '{async_block_env#0}' (ID: 411042):
      Stack is empty.
================================================================================

Thread 1 "comprehensive_a" hit Temporary breakpoint -27, comprehensive_async_test::main::{async_block#0} () at src/main.rs:109
109	#[tokio::main]
================================================================================
                            Asynchronous Backtraces
================================================================================
Process 31463:
  Thread 31463:
    Coroutine '{async_block_env#0}' (ID: 411042):
         comprehensive_async_test::main::{async_block_env#0}
================================================================================
impl_async_fn result: 500
combinators_async_fn result: 1
================================================================================
                            Asynchronous Backtraces
================================================================================
Process 31463:
  Thread 31463:
    Coroutine '{async_block_env#0}' (ID: 411042):
      Stack is empty.
================================================================================

Thread 1 "comprehensive_a" hit Temporary breakpoint -29, comprehensive_async_test::main::{async_block#0} () at src/main.rs:109
109	#[tokio::main]
================================================================================
                            Asynchronous Backtraces
================================================================================
Process 31463:
  Thread 31463:
    Coroutine '{async_block_env#0}' (ID: 411042):
         comprehensive_async_test::main::{async_block_env#0}
================================================================================
================================================================================
                            Asynchronous Backtraces
================================================================================
Process 31463:
  Thread 31463:
    Coroutine '{async_block_env#0}' (ID: 411042):
      Stack is empty.
================================================================================

Thread 1 "comprehensive_a" hit Temporary breakpoint -31, comprehensive_async_test::main::{async_block#0} () at src/main.rs:109
109	#[tokio::main]
================================================================================
                            Asynchronous Backtraces
================================================================================
Process 31463:
  Thread 31463:
    Coroutine '{async_block_env#0}' (ID: 411042):
         comprehensive_async_test::main::{async_block_env#0}
================================================================================
nested_async_fn result: 142
所有测试完成
================================================================================
                            Asynchronous Backtraces
================================================================================
Process 31463:
  Thread 31463:
    Coroutine '{async_block_env#0}' (ID: 411042):
      Stack is empty.
================================================================================
[Thread 0x7ffff76006c0 (LWP 31468) exited]
[Thread 0x7ffff7a006c0 (LWP 31467) exited]
[Inferior 1 (process 31463) exited normally]
```

##### 带生命周期的 async fn

可以跟踪：

```shell
(gdb) start-async-debug 
[rust-future-tracing] Step 1: Reading user-selected interesting functions...
[rust-future-tracing] Found interesting poll function: static fn comprehensive_async_test::lifetime_async_fn::{async_fn#0}(*mut core::task::wake::Context)
[rust-future-tracing] Mapped static fn comprehensive_async_test::lifetime_async_fn::{async_fn#0}(*mut core::task::wake::Context) -> comprehensive_async_test::lifetime_async_fn::{async_fn_env#0} (DIE offset: 407960)
[rust-future-tracing] Found 1 interesting futures:
  - comprehensive_async_test::lifetime_async_fn::{async_fn_env#0}
[rust-future-tracing] === Step 3: Performing future expansion ===
[rust-future-tracing] Converting interesting futures to DIE offsets...
[rust-future-tracing] Converting future to DIE offset: comprehensive_async_test::lifetime_async_fn::{async_fn_env#0}
[rust-future-tracing] Mapped comprehensive_async_test::lifetime_async_fn::{async_fn_env#0} -> DIE offset: 407960
[rust-future-tracing] Expanding future dependencies...
[rust-future-tracing] Loaded async dependencies from /home/iristseng/data/rust-future-tracing/results/async_dependencies.json
[rust-future-tracing] Expanding dependencies for DIE offset: 0x63998
[rust-future-tracing] Expansion complete:
  - Total expanded DIE offsets: 2
  - Leaf futures (no dependencies): 1
  - Root futures (coroutines): 2
[rust-future-tracing] Validating expanded futures with DIE tree...
[rust-future-tracing] Validation complete:
  - Async functions: 0
  - Future structs: 2
  - Other DIEs: 0
  - Invalid offsets: 0
[rust-future-tracing] === Step 3 complete ===
[rust-future-tracing] Step 3 complete. Expanded to 2 total futures
[rust-future-tracing] === Step 4: Converting expanded futures to poll functions ===
[rust-future-tracing] Converting future to poll function: {async_fn_env#0} (offset: 407960)
[rust-future-tracing] Mapped future -> poll: {async_fn_env#0} -> comprehensive_async_test::lifetime_async_fn::{async_fn#0} (DIE offset: 407806)
--Type <RET> for more, q to quit, c to continue without paging--c
[rust-future-tracing] Converting future to poll function: {async_block_env#0} (offset: 411042)
[rust-future-tracing] Mapped future -> poll: {async_block_env#0} -> comprehensive_async_test::main::{async_block#0} (DIE offset: 409942)
[rust-future-tracing] Step 4 complete. Found 2 unique poll functions:
  1. comprehensive_async_test::lifetime_async_fn::{async_fn#0}
  2. comprehensive_async_test::main::{async_block#0}
[rust-future-tracing] Step 4 complete. Ready to instrument 2 poll functions
[rust-future-tracing] Initialized AsyncBacktracePlugin for 2 poll functions.
[rust-future-tracing] === Step 5: Setting up instrumentation for poll functions ===
[rust-future-tracing] Processing future struct: {async_fn_env#0} at offset 407960
[rust-future-tracing] Ancestors: {407960: [411042]}
[rust-future-tracing] Processing future struct: {async_block_env#0} at offset 411042
[rust-future-tracing] Ancestors: {407960: [411042]}
  - Will instrument: comprehensive_async_test::lifetime_async_fn::{async_fn#0}
  - Will instrument: comprehensive_async_test::main::{async_block#0}
[rust-future-tracing] === Step 5 complete ===
[rust-future-tracing] Setting up entry breakpoint for: comprehensive_async_test::lifetime_async_fn::{async_fn#0}
[rust-future-tracing] Setting up entry breakpoint for: comprehensive_async_test::main::{async_block#0}
[rust-future-tracing] All steps complete. Instrumentation is active.
Hint: Use 'continue' or 'run' to start the program, then 'inspect-async' to see results.
(gdb) run
Starting program: /home/iristseng/data/rust-future-tracing/tests/comprehensive_async_test/target/debug/comprehensive_async_test 

This GDB supports auto-downloading debuginfo from the following URLs:
  <https://debuginfod.ubuntu.com>
Enable debuginfod for this session? (y or [n]) y
Debuginfod has been enabled.
To make this setting permanent, add 'set debuginfod enabled on' to .gdbinit.
[Thread debugging using libthread_db enabled]
Using host libthread_db library "/lib/x86_64-linux-gnu/libthread_db.so.1".
[New Thread 0x7ffff7a006c0 (LWP 31504)]
[New Thread 0x7ffff76006c0 (LWP 31505)]
开始测试各种异步实现方式

Thread 1 "comprehensive_a" hit Temporary breakpoint -13, comprehensive_async_test::main::{async_block#0} () at src/main.rs:109
109	#[tokio::main]
================================================================================
                            Asynchronous Backtraces
================================================================================
Process 31501:
  Thread 31501:
    Coroutine '{async_block_env#0}' (ID: 411042):
         comprehensive_async_test::main::{async_block_env#0}
================================================================================
standard_async_fn result: 42
================================================================================
                            Asynchronous Backtraces
================================================================================
Process 31501:
  Thread 31501:
    Coroutine '{async_block_env#0}' (ID: 411042):
      Stack is empty.
================================================================================

Thread 1 "comprehensive_a" hit Temporary breakpoint -14, comprehensive_async_test::main::{async_block#0} () at src/main.rs:109
109	#[tokio::main]
================================================================================
                            Asynchronous Backtraces
================================================================================
Process 31501:
  Thread 31501:
    Coroutine '{async_block_env#0}' (ID: 411042):
         comprehensive_async_test::main::{async_block_env#0}
================================================================================
async_block result: 100
================================================================================
                            Asynchronous Backtraces
================================================================================
Process 31501:
  Thread 31501:
    Coroutine '{async_block_env#0}' (ID: 411042):
      Stack is empty.
================================================================================

Thread 1 "comprehensive_a" hit Temporary breakpoint -16, comprehensive_async_test::main::{async_block#0} () at src/main.rs:109
109	#[tokio::main]
================================================================================
                            Asynchronous Backtraces
================================================================================
Process 31501:
  Thread 31501:
    Coroutine '{async_block_env#0}' (ID: 411042):
         comprehensive_async_test::main::{async_block_env#0}
================================================================================
boxed_future result: 200
================================================================================
                            Asynchronous Backtraces
================================================================================
Process 31501:
  Thread 31501:
    Coroutine '{async_block_env#0}' (ID: 411042):
      Stack is empty.
================================================================================

Thread 1 "comprehensive_a" hit Temporary breakpoint -18, comprehensive_async_test::main::{async_block#0} () at src/main.rs:109
109	#[tokio::main]
================================================================================
                            Asynchronous Backtraces
================================================================================
Process 31501:
  Thread 31501:
    Coroutine '{async_block_env#0}' (ID: 411042):
         comprehensive_async_test::main::{async_block_env#0}
================================================================================
async_trait result: 300
================================================================================
                            Asynchronous Backtraces
================================================================================
Process 31501:
  Thread 31501:
    Coroutine '{async_block_env#0}' (ID: 411042):
      Stack is empty.
================================================================================

Thread 1 "comprehensive_a" hit Temporary breakpoint -20, comprehensive_async_test::main::{async_block#0} () at src/main.rs:109
109	#[tokio::main]
================================================================================
                            Asynchronous Backtraces
================================================================================
Process 31501:
  Thread 31501:
    Coroutine '{async_block_env#0}' (ID: 411042):
         comprehensive_async_test::main::{async_block_env#0}
================================================================================
generic_async_fn result: 600
================================================================================
                            Asynchronous Backtraces
================================================================================
Process 31501:
  Thread 31501:
    Coroutine '{async_block_env#0}' (ID: 411042):
      Stack is empty.
================================================================================

Thread 1 "comprehensive_a" hit Temporary breakpoint -22, comprehensive_async_test::main::{async_block#0} () at src/main.rs:109
109	#[tokio::main]
================================================================================
                            Asynchronous Backtraces
================================================================================
Process 31501:
  Thread 31501:
    Coroutine '{async_block_env#0}' (ID: 411042):
         comprehensive_async_test::main::{async_block_env#0}
================================================================================

Thread 1 "comprehensive_a" hit Temporary breakpoint -24, comprehensive_async_test::lifetime_async_fn::{async_fn#0} ()
    at src/main.rs:74
74	async fn lifetime_async_fn(s: &str) -> String {
================================================================================
                            Asynchronous Backtraces
================================================================================
Process 31501:
  Thread 31501:
    Coroutine '{async_block_env#0}' (ID: 411042):
         comprehensive_async_test::main::{async_block_env#0}
        -> comprehensive_async_test::lifetime_async_fn::{async_fn_env#0}
================================================================================
================================================================================
                            Asynchronous Backtraces
================================================================================
Process 31501:
  Thread 31501:
    Coroutine '{async_block_env#0}' (ID: 411042):
         comprehensive_async_test::main::{async_block_env#0}
================================================================================
lifetime_async_fn result: hello
================================================================================
                            Asynchronous Backtraces
================================================================================
Process 31501:
  Thread 31501:
    Coroutine '{async_block_env#0}' (ID: 411042):
      Stack is empty.
================================================================================

Thread 1 "comprehensive_a" hit Temporary breakpoint -25, comprehensive_async_test::main::{async_block#0} () at src/main.rs:109
109	#[tokio::main]
================================================================================
                            Asynchronous Backtraces
================================================================================
Process 31501:
  Thread 31501:
    Coroutine '{async_block_env#0}' (ID: 411042):
         comprehensive_async_test::main::{async_block_env#0}
================================================================================
impl_async_fn result: 500
combinators_async_fn result: 1
================================================================================
                            Asynchronous Backtraces
================================================================================
Process 31501:
  Thread 31501:
    Coroutine '{async_block_env#0}' (ID: 411042):
      Stack is empty.
================================================================================

Thread 1 "comprehensive_a" hit Temporary breakpoint -29, comprehensive_async_test::main::{async_block#0} () at src/main.rs:109
109	#[tokio::main]
================================================================================
                            Asynchronous Backtraces
================================================================================
Process 31501:
  Thread 31501:
    Coroutine '{async_block_env#0}' (ID: 411042):
         comprehensive_async_test::main::{async_block_env#0}
================================================================================
================================================================================
                            Asynchronous Backtraces
================================================================================
Process 31501:
  Thread 31501:
    Coroutine '{async_block_env#0}' (ID: 411042):
      Stack is empty.
================================================================================

Thread 1 "comprehensive_a" hit Temporary breakpoint -31, comprehensive_async_test::main::{async_block#0} () at src/main.rs:109
109	#[tokio::main]
================================================================================
                            Asynchronous Backtraces
================================================================================
Process 31501:
  Thread 31501:
    Coroutine '{async_block_env#0}' (ID: 411042):
         comprehensive_async_test::main::{async_block_env#0}
================================================================================
nested_async_fn result: 142
所有测试完成
================================================================================
                            Asynchronous Backtraces
================================================================================
Process 31501:
  Thread 31501:
    Coroutine '{async_block_env#0}' (ID: 411042):
      Stack is empty.
================================================================================
[Thread 0x7ffff76006c0 (LWP 31505) exited]
[Thread 0x7ffff7a006c0 (LWP 31504) exited]
[Inferior 1 (process 31501) exited normally]
```

##### 在 impl 块中的 async fn

能跟踪：

```shell
(gdb) start-async-debug 
[rust-future-tracing] Step 1: Reading user-selected interesting functions...
[rust-future-tracing] Found interesting poll function: static fn comprehensive_async_test::{impl#1}::impl_async_fn::{async_fn#0}(*mut core::task::wake::Context)
[rust-future-tracing] Mapped static fn comprehensive_async_test::{impl#1}::impl_async_fn::{async_fn#0}(*mut core::task::wake::Context) -> comprehensive_async_test::{impl#1}::impl_async_fn::{async_fn_env#0} (DIE offset: 408307)
[rust-future-tracing] Found 1 interesting futures:
  - comprehensive_async_test::{impl#1}::impl_async_fn::{async_fn_env#0}
[rust-future-tracing] === Step 3: Performing future expansion ===
[rust-future-tracing] Converting interesting futures to DIE offsets...
[rust-future-tracing] Converting future to DIE offset: comprehensive_async_test::{impl#1}::impl_async_fn::{async_fn_env#0}
[rust-future-tracing] Mapped comprehensive_async_test::{impl#1}::impl_async_fn::{async_fn_env#0} -> DIE offset: 408307
[rust-future-tracing] Expanding future dependencies...
[rust-future-tracing] Loaded async dependencies from /home/iristseng/data/rust-future-tracing/results/async_dependencies.json
[rust-future-tracing] Expanding dependencies for DIE offset: 0x63af3
[rust-future-tracing] Expansion complete:
  - Total expanded DIE offsets: 2
  - Leaf futures (no dependencies): 1
  - Root futures (coroutines): 2
[rust-future-tracing] Validating expanded futures with DIE tree...
[rust-future-tracing] Validation complete:
  - Async functions: 0
  - Future structs: 2
  - Other DIEs: 0
  - Invalid offsets: 0
[rust-future-tracing] === Step 3 complete ===
[rust-future-tracing] Step 3 complete. Expanded to 2 total futures
[rust-future-tracing] === Step 4: Converting expanded futures to poll functions ===
[rust-future-tracing] Converting future to poll function: {async_block_env#0} (offset: 411042)
[rust-future-tracing] Mapped future -> poll: {async_block_env#0} -> comprehensive_async_test::main::{async_block#0} (DIE offset: 409942)
--Type <RET> for more, q to quit, c to continue without paging--c
[rust-future-tracing] Converting future to poll function: {async_fn_env#0} (offset: 408307)
[rust-future-tracing] Mapped future -> poll: {async_fn_env#0} -> comprehensive_async_test::{impl#1}::impl_async_fn::{async_fn#0} (DIE offset: 408158)
[rust-future-tracing] Step 4 complete. Found 2 unique poll functions:
  1. comprehensive_async_test::main::{async_block#0}
  2. comprehensive_async_test::{impl#1}::impl_async_fn::{async_fn#0}
[rust-future-tracing] Step 4 complete. Ready to instrument 2 poll functions
[rust-future-tracing] Initialized AsyncBacktracePlugin for 2 poll functions.
[rust-future-tracing] === Step 5: Setting up instrumentation for poll functions ===
[rust-future-tracing] Processing future struct: {async_block_env#0} at offset 411042
[rust-future-tracing] Ancestors: {408307: [411042]}
[rust-future-tracing] Processing future struct: {async_fn_env#0} at offset 408307
[rust-future-tracing] Ancestors: {408307: [411042]}
  - Will instrument: comprehensive_async_test::main::{async_block#0}
  - Will instrument: comprehensive_async_test::{impl#1}::impl_async_fn::{async_fn#0}
[rust-future-tracing] === Step 5 complete ===
[rust-future-tracing] Setting up entry breakpoint for: comprehensive_async_test::main::{async_block#0}
[rust-future-tracing] Setting up entry breakpoint for: comprehensive_async_test::{impl#1}::impl_async_fn::{async_fn#0}
[rust-future-tracing] All steps complete. Instrumentation is active.
Hint: Use 'continue' or 'run' to start the program, then 'inspect-async' to see results.
(gdb) run
Starting program: /home/iristseng/data/rust-future-tracing/tests/comprehensive_async_test/target/debug/comprehensive_async_test 

This GDB supports auto-downloading debuginfo from the following URLs:
  <https://debuginfod.ubuntu.com>
Enable debuginfod for this session? (y or [n]) y
Debuginfod has been enabled.
To make this setting permanent, add 'set debuginfod enabled on' to .gdbinit.
Downloading separate debug info for system-supplied DSO at 0x7ffff7fc3000
[Thread debugging using libthread_db enabled]                                                                                   
Using host libthread_db library "/lib/x86_64-linux-gnu/libthread_db.so.1".
[New Thread 0x7ffff7a006c0 (LWP 32088)]
[New Thread 0x7ffff76006c0 (LWP 32089)]
开始测试各种异步实现方式

Thread 1 "comprehensive_a" hit Temporary breakpoint -13, comprehensive_async_test::main::{async_block#0} () at src/main.rs:109
109	#[tokio::main]
================================================================================
                            Asynchronous Backtraces
================================================================================
Process 32084:
  Thread 32084:
    Coroutine '{async_block_env#0}' (ID: 411042):
         comprehensive_async_test::main::{async_block_env#0}
================================================================================
standard_async_fn result: 42
================================================================================
                            Asynchronous Backtraces
================================================================================
Process 32084:
  Thread 32084:
    Coroutine '{async_block_env#0}' (ID: 411042):
      Stack is empty.
================================================================================

Thread 1 "comprehensive_a" hit Temporary breakpoint -14, comprehensive_async_test::main::{async_block#0} () at src/main.rs:109
109	#[tokio::main]
================================================================================
                            Asynchronous Backtraces
================================================================================
Process 32084:
  Thread 32084:
    Coroutine '{async_block_env#0}' (ID: 411042):
         comprehensive_async_test::main::{async_block_env#0}
================================================================================
async_block result: 100
================================================================================
                            Asynchronous Backtraces
================================================================================
Process 32084:
  Thread 32084:
    Coroutine '{async_block_env#0}' (ID: 411042):
      Stack is empty.
================================================================================

Thread 1 "comprehensive_a" hit Temporary breakpoint -16, comprehensive_async_test::main::{async_block#0} () at src/main.rs:109
109	#[tokio::main]
================================================================================
                            Asynchronous Backtraces
================================================================================
Process 32084:
  Thread 32084:
    Coroutine '{async_block_env#0}' (ID: 411042):
         comprehensive_async_test::main::{async_block_env#0}
================================================================================
boxed_future result: 200
================================================================================
                            Asynchronous Backtraces
================================================================================
Process 32084:
  Thread 32084:
    Coroutine '{async_block_env#0}' (ID: 411042):
      Stack is empty.
================================================================================

Thread 1 "comprehensive_a" hit Temporary breakpoint -18, comprehensive_async_test::main::{async_block#0} () at src/main.rs:109
109	#[tokio::main]
================================================================================
                            Asynchronous Backtraces
================================================================================
Process 32084:
  Thread 32084:
    Coroutine '{async_block_env#0}' (ID: 411042):
         comprehensive_async_test::main::{async_block_env#0}
================================================================================
async_trait result: 300
================================================================================
                            Asynchronous Backtraces
================================================================================
Process 32084:
  Thread 32084:
    Coroutine '{async_block_env#0}' (ID: 411042):
      Stack is empty.
================================================================================

Thread 1 "comprehensive_a" hit Temporary breakpoint -20, comprehensive_async_test::main::{async_block#0} () at src/main.rs:109
109	#[tokio::main]
================================================================================
                            Asynchronous Backtraces
================================================================================
Process 32084:
  Thread 32084:
    Coroutine '{async_block_env#0}' (ID: 411042):
         comprehensive_async_test::main::{async_block_env#0}
================================================================================
generic_async_fn result: 600
================================================================================
                            Asynchronous Backtraces
================================================================================
Process 32084:
  Thread 32084:
    Coroutine '{async_block_env#0}' (ID: 411042):
      Stack is empty.
================================================================================

Thread 1 "comprehensive_a" hit Temporary breakpoint -22, comprehensive_async_test::main::{async_block#0} () at src/main.rs:109
109	#[tokio::main]
================================================================================
                            Asynchronous Backtraces
================================================================================
Process 32084:
  Thread 32084:
    Coroutine '{async_block_env#0}' (ID: 411042):
         comprehensive_async_test::main::{async_block_env#0}
================================================================================
lifetime_async_fn result: hello
================================================================================
                            Asynchronous Backtraces
================================================================================
Process 32084:
  Thread 32084:
    Coroutine '{async_block_env#0}' (ID: 411042):
      Stack is empty.
================================================================================

Thread 1 "comprehensive_a" hit Temporary breakpoint -24, comprehensive_async_test::main::{async_block#0} () at src/main.rs:109
109	#[tokio::main]
================================================================================
                            Asynchronous Backtraces
================================================================================
Process 32084:
  Thread 32084:
    Coroutine '{async_block_env#0}' (ID: 411042):
         comprehensive_async_test::main::{async_block_env#0}
================================================================================

Thread 1 "comprehensive_a" hit Temporary breakpoint -26, comprehensive_async_test::{impl#1}::impl_async_fn::{async_fn#0} ()
    at src/main.rs:83
83	    async fn impl_async_fn(&self) -> i32 {
================================================================================
                            Asynchronous Backtraces
================================================================================
Process 32084:
  Thread 32084:
    Coroutine '{async_block_env#0}' (ID: 411042):
         comprehensive_async_test::main::{async_block_env#0}
        -> comprehensive_async_test::{impl#1}::impl_async_fn::{async_fn_env#0}
================================================================================
================================================================================
                            Asynchronous Backtraces
================================================================================
Process 32084:
  Thread 32084:
    Coroutine '{async_block_env#0}' (ID: 411042):
         comprehensive_async_test::main::{async_block_env#0}
================================================================================
impl_async_fn result: 500
combinators_async_fn result: 1
================================================================================
                            Asynchronous Backtraces
================================================================================
Process 32084:
  Thread 32084:
    Coroutine '{async_block_env#0}' (ID: 411042):
      Stack is empty.
================================================================================

Thread 1 "comprehensive_a" hit Temporary breakpoint -27, comprehensive_async_test::main::{async_block#0} () at src/main.rs:109
109	#[tokio::main]
================================================================================
                            Asynchronous Backtraces
================================================================================
Process 32084:
  Thread 32084:
    Coroutine '{async_block_env#0}' (ID: 411042):
         comprehensive_async_test::main::{async_block_env#0}
================================================================================
================================================================================
                            Asynchronous Backtraces
================================================================================
Process 32084:
  Thread 32084:
    Coroutine '{async_block_env#0}' (ID: 411042):
      Stack is empty.
================================================================================

Thread 1 "comprehensive_a" hit Temporary breakpoint -31, comprehensive_async_test::main::{async_block#0} () at src/main.rs:109
109	#[tokio::main]
================================================================================
                            Asynchronous Backtraces
================================================================================
Process 32084:
  Thread 32084:
    Coroutine '{async_block_env#0}' (ID: 411042):
         comprehensive_async_test::main::{async_block_env#0}
================================================================================
nested_async_fn result: 142
所有测试完成
================================================================================
                            Asynchronous Backtraces
================================================================================
Process 32084:
  Thread 32084:
    Coroutine '{async_block_env#0}' (ID: 411042):
      Stack is empty.
================================================================================
[Thread 0x7ffff76006c0 (LWP 32089) exited]
[Thread 0x7ffff7a006c0 (LWP 32088) exited]
[Inferior 1 (process 32084) exited normally]

```



##### 使用 futures crate 的 combinators

可以跟踪。

```shell
(gdb) start-async-debug 
[rust-future-tracing] Step 1: Reading user-selected interesting functions...
[rust-future-tracing] Found interesting poll function: static fn comprehensive_async_test::combinators_async_fn::{async_fn#0}(*mut core::task::wake::Context)
[rust-future-tracing] Mapped static fn comprehensive_async_test::combinators_async_fn::{async_fn#0}(*mut core::task::wake::Context) -> comprehensive_async_test::combinators_async_fn::{async_fn_env#0} (DIE offset: 409160)
[rust-future-tracing] Found 1 interesting futures:
  - comprehensive_async_test::combinators_async_fn::{async_fn_env#0}
[rust-future-tracing] === Step 3: Performing future expansion ===
[rust-future-tracing] Converting interesting futures to DIE offsets...
[rust-future-tracing] Converting future to DIE offset: comprehensive_async_test::combinators_async_fn::{async_fn_env#0}
[rust-future-tracing] Mapped comprehensive_async_test::combinators_async_fn::{async_fn_env#0} -> DIE offset: 409160
[rust-future-tracing] Expanding future dependencies...
[rust-future-tracing] Loaded async dependencies from /home/iristseng/data/rust-future-tracing/results/async_dependencies.json
[rust-future-tracing] Expanding dependencies for DIE offset: 0x63e48
[rust-future-tracing] Expansion complete:
  - Total expanded DIE offsets: 7
  - Leaf futures (no dependencies): 3
  - Root futures (coroutines): 3
[rust-future-tracing] Validating expanded futures with DIE tree...
[rust-future-tracing] Validation complete:
  - Async functions: 0
  - Future structs: 7
  - Other DIEs: 0
  - Invalid offsets: 0
[rust-future-tracing] === Step 3 complete ===
[rust-future-tracing] Step 3 complete. Expanded to 7 total futures
[rust-future-tracing] === Step 4: Converting expanded futures to poll functions ===
[rust-future-tracing] Converting future to poll function: {async_block_env#0} (offset: 411042)
[rust-future-tracing] Mapped future -> poll: {async_block_env#0} -> comprehensive_async_test::main::{async_block#0} (DIE offset: 409942)
--Type <RET> for more, q to quit, c to continue without paging--c
[rust-future-tracing] Converting future to poll function: Option<(core::pin::Pin<alloc::boxed::Box<comprehensive_async_test::combinators_async_fn::{async_fn#0}::{async_block_env#0}, alloc::alloc::Global>>, core::pin::Pin<alloc::boxed::Box<comprehensive_async_test::combinators_async_fn::{async_fn#0}::{async_block_env#1}, alloc::alloc::Global>>)> (offset: 397927)
[rust-future-tracing] No poll function found for future struct at offset: 397927
[rust-future-tracing] WARNING: No poll function found for future: Option<(core::pin::Pin<alloc::boxed::Box<comprehensive_async_test::combinators_async_fn::{async_fn#0}::{async_block_env#0}, alloc::alloc::Global>>, core::pin::Pin<alloc::boxed::Box<comprehensive_async_test::combinators_async_fn::{async_fn#0}::{async_block_env#1}, alloc::alloc::Global>>)>
[rust-future-tracing] Converting future to poll function: {async_fn_env#0} (offset: 409160)
[rust-future-tracing] Mapped future -> poll: {async_fn_env#0} -> comprehensive_async_test::combinators_async_fn::{async_fn#0} (DIE offset: 408794)
[rust-future-tracing] Converting future to poll function: Select<core::pin::Pin<alloc::boxed::Box<comprehensive_async_test::combinators_async_fn::{async_fn#0}::{async_block_env#0}, alloc::alloc::Global>>, core::pin::Pin<alloc::boxed::Box<comprehensive_async_test::combinators_async_fn::{async_fn#0}::{async_block_env#1}, alloc::alloc::Global>>> (offset: 412010)
[rust-future-tracing] No poll function found for future struct at offset: 412010
[rust-future-tracing] WARNING: No poll function found for future: Select<core::pin::Pin<alloc::boxed::Box<comprehensive_async_test::combinators_async_fn::{async_fn#0}::{async_block_env#0}, alloc::alloc::Global>>, core::pin::Pin<alloc::boxed::Box<comprehensive_async_test::combinators_async_fn::{async_fn#0}::{async_block_env#1}, alloc::alloc::Global>>>
[rust-future-tracing] Converting future to poll function: (core::pin::Pin<alloc::boxed::Box<comprehensive_async_test::combinators_async_fn::{async_fn#0}::{async_block_env#0}, alloc::alloc::Global>>, core::pin::Pin<alloc::boxed::Box<comprehensive_async_test::combinators_async_fn::{async_fn#0}::{async_block_env#1}, alloc::alloc::Global>>) (offset: 412186)
[rust-future-tracing] No poll function found for future struct at offset: 412186
[rust-future-tracing] WARNING: No poll function found for future: (core::pin::Pin<alloc::boxed::Box<comprehensive_async_test::combinators_async_fn::{async_fn#0}::{async_block_env#0}, alloc::alloc::Global>>, core::pin::Pin<alloc::boxed::Box<comprehensive_async_test::combinators_async_fn::{async_fn#0}::{async_block_env#1}, alloc::alloc::Global>>)
[rust-future-tracing] Converting future to poll function: Pin<alloc::boxed::Box<comprehensive_async_test::combinators_async_fn::{async_fn#0}::{async_block_env#1}, alloc::alloc::Global>> (offset: 392635)
[rust-future-tracing] No poll function found for future struct at offset: 392635
[rust-future-tracing] WARNING: No poll function found for future: Pin<alloc::boxed::Box<comprehensive_async_test::combinators_async_fn::{async_fn#0}::{async_block_env#1}, alloc::alloc::Global>>
[rust-future-tracing] Converting future to poll function: Pin<alloc::boxed::Box<comprehensive_async_test::combinators_async_fn::{async_fn#0}::{async_block_env#0}, alloc::alloc::Global>> (offset: 392605)
[rust-future-tracing] No poll function found for future struct at offset: 392605
[rust-future-tracing] WARNING: No poll function found for future: Pin<alloc::boxed::Box<comprehensive_async_test::combinators_async_fn::{async_fn#0}::{async_block_env#0}, alloc::alloc::Global>>
[rust-future-tracing] Step 4 complete. Found 2 unique poll functions:
  1. comprehensive_async_test::main::{async_block#0}
  2. comprehensive_async_test::combinators_async_fn::{async_fn#0}
[rust-future-tracing] Step 4 complete. Ready to instrument 2 poll functions
[rust-future-tracing] Initialized AsyncBacktracePlugin for 2 poll functions.
[rust-future-tracing] === Step 5: Setting up instrumentation for poll functions ===
[rust-future-tracing] Processing future struct: {async_block_env#0} at offset 411042
[rust-future-tracing] Ancestors: {392605: [397927, 409160, 411042, 412010, 412186], 392635: [397927, 409160, 411042, 412010, 412186], 412186: [397927, 409160, 411042, 412010], 397927: [409160, 411042, 412010], 412010: [409160, 411042], 409160: [411042]}
[rust-future-tracing] Processing future struct: Option<(core::pin::Pin<alloc::boxed::Box<comprehensive_async_test::combinators_async_fn::{async_fn#0}::{async_block_env#0}, alloc::alloc::Global>>, core::pin::Pin<alloc::boxed::Box<comprehensive_async_test::combinators_async_fn::{async_fn#0}::{async_block_env#1}, alloc::alloc::Global>>)> at offset 397927
[rust-future-tracing] Ancestors: {392605: [397927, 409160, 411042, 412010, 412186], 392635: [397927, 409160, 411042, 412010, 412186], 412186: [397927, 409160, 411042, 412010], 397927: [409160, 411042, 412010], 412010: [409160, 411042], 409160: [411042]}
[rust-future-tracing] No poll function found for future struct at offset: 397927
[rust-future-tracing] Processing future struct: {async_fn_env#0} at offset 409160
[rust-future-tracing] Ancestors: {392605: [397927, 409160, 411042, 412010, 412186], 392635: [397927, 409160, 411042, 412010, 412186], 412186: [397927, 409160, 411042, 412010], 397927: [409160, 411042, 412010], 412010: [409160, 411042], 409160: [411042]}
[rust-future-tracing] Processing future struct: Select<core::pin::Pin<alloc::boxed::Box<comprehensive_async_test::combinators_async_fn::{async_fn#0}::{async_block_env#0}, alloc::alloc::Global>>, core::pin::Pin<alloc::boxed::Box<comprehensive_async_test::combinators_async_fn::{async_fn#0}::{async_block_env#1}, alloc::alloc::Global>>> at offset 412010
[rust-future-tracing] Ancestors: {392605: [397927, 409160, 411042, 412010, 412186], 392635: [397927, 409160, 411042, 412010, 412186], 412186: [397927, 409160, 411042, 412010], 397927: [409160, 411042, 412010], 412010: [409160, 411042], 409160: [411042]}
[rust-future-tracing] No poll function found for future struct at offset: 412010
[rust-future-tracing] Processing future struct: (core::pin::Pin<alloc::boxed::Box<comprehensive_async_test::combinators_async_fn::{async_fn#0}::{async_block_env#0}, alloc::alloc::Global>>, core::pin::Pin<alloc::boxed::Box<comprehensive_async_test::combinators_async_fn::{async_fn#0}::{async_block_env#1}, alloc::alloc::Global>>) at offset 412186
[rust-future-tracing] Ancestors: {392605: [397927, 409160, 411042, 412010, 412186], 392635: [397927, 409160, 411042, 412010, 412186], 412186: [397927, 409160, 411042, 412010], 397927: [409160, 411042, 412010], 412010: [409160, 411042], 409160: [411042]}
[rust-future-tracing] No poll function found for future struct at offset: 412186
[rust-future-tracing] Processing future struct: Pin<alloc::boxed::Box<comprehensive_async_test::combinators_async_fn::{async_fn#0}::{async_block_env#1}, alloc::alloc::Global>> at offset 392635
[rust-future-tracing] Ancestors: {392605: [397927, 409160, 411042, 412010, 412186], 392635: [397927, 409160, 411042, 412010, 412186], 412186: [397927, 409160, 411042, 412010], 397927: [409160, 411042, 412010], 412010: [409160, 411042], 409160: [411042]}
[rust-future-tracing] No poll function found for future struct at offset: 392635
[rust-future-tracing] Processing future struct: Pin<alloc::boxed::Box<comprehensive_async_test::combinators_async_fn::{async_fn#0}::{async_block_env#0}, alloc::alloc::Global>> at offset 392605
[rust-future-tracing] Ancestors: {392605: [397927, 409160, 411042, 412010, 412186], 392635: [397927, 409160, 411042, 412010, 412186], 412186: [397927, 409160, 411042, 412010], 397927: [409160, 411042, 412010], 412010: [409160, 411042], 409160: [411042]}
[rust-future-tracing] No poll function found for future struct at offset: 392605
  - Will instrument: comprehensive_async_test::main::{async_block#0}
  - Will instrument: comprehensive_async_test::combinators_async_fn::{async_fn#0}
[rust-future-tracing] === Step 5 complete ===
[rust-future-tracing] Setting up entry breakpoint for: comprehensive_async_test::main::{async_block#0}
[rust-future-tracing] Setting up entry breakpoint for: comprehensive_async_test::combinators_async_fn::{async_fn#0}
[rust-future-tracing] All steps complete. Instrumentation is active.
Hint: Use 'continue' or 'run' to start the program, then 'inspect-async' to see results.
(gdb) run
Thread 1 "comprehensive_a" hit Temporary breakpoint -13, comprehensive_async_test::main::{async_block#0} () at src/main.rs:109
109	#[tokio::main]
================================================================================
                            Asynchronous Backtraces
================================================================================
Process 32383:
  Thread 32383:
    Coroutine '{async_block_env#0}' (ID: 411042):
         comprehensive_async_test::main::{async_block_env#0}
================================================================================
standard_async_fn result: 42
================================================================================
                            Asynchronous Backtraces
================================================================================
Process 32383:
  Thread 32383:
    Coroutine '{async_block_env#0}' (ID: 411042):
      Stack is empty.
================================================================================

Thread 1 "comprehensive_a" hit Temporary breakpoint -14, comprehensive_async_test::main::{async_block#0} () at src/main.rs:109
109	#[tokio::main]
================================================================================
                            Asynchronous Backtraces
================================================================================
Process 32383:
  Thread 32383:
    Coroutine '{async_block_env#0}' (ID: 411042):
         comprehensive_async_test::main::{async_block_env#0}
================================================================================
async_block result: 100
================================================================================
                            Asynchronous Backtraces
================================================================================
Process 32383:
  Thread 32383:
    Coroutine '{async_block_env#0}' (ID: 411042):
      Stack is empty.
================================================================================

Thread 1 "comprehensive_a" hit Temporary breakpoint -16, comprehensive_async_test::main::{async_block#0} () at src/main.rs:109
109	#[tokio::main]
================================================================================
                            Asynchronous Backtraces
================================================================================
Process 32383:
  Thread 32383:
    Coroutine '{async_block_env#0}' (ID: 411042):
         comprehensive_async_test::main::{async_block_env#0}
================================================================================
boxed_future result: 200
================================================================================
                            Asynchronous Backtraces
================================================================================
Process 32383:
  Thread 32383:
    Coroutine '{async_block_env#0}' (ID: 411042):
      Stack is empty.
================================================================================

Thread 1 "comprehensive_a" hit Temporary breakpoint -18, comprehensive_async_test::main::{async_block#0} () at src/main.rs:109
109	#[tokio::main]
================================================================================
                            Asynchronous Backtraces
================================================================================
Process 32383:
  Thread 32383:
    Coroutine '{async_block_env#0}' (ID: 411042):
         comprehensive_async_test::main::{async_block_env#0}
================================================================================
async_trait result: 300
================================================================================
                            Asynchronous Backtraces
================================================================================
Process 32383:
  Thread 32383:
    Coroutine '{async_block_env#0}' (ID: 411042):
      Stack is empty.
================================================================================

Thread 1 "comprehensive_a" hit Temporary breakpoint -20, comprehensive_async_test::main::{async_block#0} () at src/main.rs:109
109	#[tokio::main]
================================================================================
                            Asynchronous Backtraces
================================================================================
Process 32383:
  Thread 32383:
    Coroutine '{async_block_env#0}' (ID: 411042):
         comprehensive_async_test::main::{async_block_env#0}
================================================================================
generic_async_fn result: 600
================================================================================
                            Asynchronous Backtraces
================================================================================
Process 32383:
  Thread 32383:
    Coroutine '{async_block_env#0}' (ID: 411042):
      Stack is empty.
================================================================================

Thread 1 "comprehensive_a" hit Temporary breakpoint -22, comprehensive_async_test::main::{async_block#0} () at src/main.rs:109
109	#[tokio::main]
================================================================================
                            Asynchronous Backtraces
================================================================================
Process 32383:
  Thread 32383:
    Coroutine '{async_block_env#0}' (ID: 411042):
         comprehensive_async_test::main::{async_block_env#0}
================================================================================
lifetime_async_fn result: hello
================================================================================
                            Asynchronous Backtraces
================================================================================
Process 32383:
  Thread 32383:
    Coroutine '{async_block_env#0}' (ID: 411042):
      Stack is empty.
================================================================================

Thread 1 "comprehensive_a" hit Temporary breakpoint -24, comprehensive_async_test::main::{async_block#0} () at src/main.rs:109
109	#[tokio::main]
================================================================================
                            Asynchronous Backtraces
================================================================================
Process 32383:
  Thread 32383:
    Coroutine '{async_block_env#0}' (ID: 411042):
         comprehensive_async_test::main::{async_block_env#0}
================================================================================
impl_async_fn result: 500
combinators_async_fn result: 1
================================================================================
                            Asynchronous Backtraces
================================================================================
Process 32383:
  Thread 32383:
    Coroutine '{async_block_env#0}' (ID: 411042):
      Stack is empty.
================================================================================

Thread 1 "comprehensive_a" hit Temporary breakpoint -26, comprehensive_async_test::main::{async_block#0} () at src/main.rs:109
109	#[tokio::main]
================================================================================
                            Asynchronous Backtraces
================================================================================
Process 32383:
  Thread 32383:
    Coroutine '{async_block_env#0}' (ID: 411042):
         comprehensive_async_test::main::{async_block_env#0}
================================================================================
================================================================================
                            Asynchronous Backtraces
================================================================================
Process 32383:
  Thread 32383:
    Coroutine '{async_block_env#0}' (ID: 411042):
      Stack is empty.
================================================================================

Thread 1 "comprehensive_a" hit Temporary breakpoint -29, comprehensive_async_test::main::{async_block#0} () at src/main.rs:109
109	#[tokio::main]
================================================================================
                            Asynchronous Backtraces
================================================================================
Process 32383:
  Thread 32383:
    Coroutine '{async_block_env#0}' (ID: 411042):
         comprehensive_async_test::main::{async_block_env#0}
================================================================================
nested_async_fn result: 142
所有测试完成
================================================================================
                            Asynchronous Backtraces
================================================================================
Process 32383:
  Thread 32383:
    Coroutine '{async_block_env#0}' (ID: 411042):
      Stack is empty.
================================================================================
[Thread 0x7ffff76006c0 (LWP 32387) exited]
[Thread 0x7ffff7a006c0 (LWP 32386) exited]
[Inferior 1 (process 32383) exited normally]
```

这个结果的原因：`combinators_async_fn` 被编译器深度优化，其函数体被完全“内联” 到了它的调用者（也就是 `main` 函数）的内部，导致对它自身的 `poll` 函数的直接调用从未发生。另外 combinators 内部的poll函数有些特殊，都是我们工具无法跟踪的类型，所以这个结果是没有问题的。



